<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Star KCA Academy</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0a0d15;
      --panel: #121a2b;
      --panel2: #1a2440;
      --text: #eef3ff;
      --muted: #9aa6c2;
      --line: #2d3d60;
      --accent: #8b5cf6;
      --accent2: #ec4899;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #1f2d4e 0%, #0d1425 45%, #070a12 100%);
    }
    .container { width: min(1160px, 92vw); margin: 0 auto; }
    header {
      position: sticky; top: 0; z-index: 30;
      backdrop-filter: blur(8px);
      background: rgba(10, 13, 21, .9);
      border-bottom: 1px solid var(--line);
    }
    .topbar { min-height: 68px; display: flex; align-items: center; justify-content: space-between; gap: .7rem; flex-wrap: wrap; padding: .8rem 0; }
    .brand h1 { margin: 0; font-size: 1.02rem; text-transform: uppercase; letter-spacing: .08em; }
    .brand p { margin: .2rem 0 0; color: var(--muted); font-size: .8rem; }
    nav { display: flex; gap: .5rem; flex-wrap: wrap; }
    .nav-link {
      text-decoration: none; color: var(--text); background: var(--panel);
      border: 1px solid var(--line); border-radius: 999px; padding: .42rem .74rem; font-size: .84rem;
    }
    .nav-link.active { background: linear-gradient(120deg, var(--accent), var(--accent2)); border-color: transparent; }
    main { padding: 1rem 0 2.6rem; }
    .page { display: none; }
    .page.active { display: block; }
    .card {
      background: linear-gradient(180deg, #19243d 0%, #111827 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    h2, h3 { margin: .2rem 0 .85rem; }
    .small { color: var(--muted); font-size: .82rem; }
    .filters { display: flex; flex-wrap: wrap; gap: .55rem; margin-bottom: .85rem; }
    input, select {
      border-radius: 10px; border: 1px solid var(--line);
      background: #0d1527; color: var(--text); padding: .52rem .7rem;
    }
    .contestants-grid { display: grid; gap: .8rem; grid-template-columns: repeat(auto-fill, minmax(178px, 1fr)); }
    .contestant-card {
      border: 1px solid var(--line); border-radius: 12px; overflow: hidden; cursor: pointer; background: #0d1526;
      transition: transform .12s ease;
    }
    .contestant-card:hover { transform: translateY(-2px); }
    .contestant-card img { width: 100%; height: 165px; object-fit: cover; display: block; }
    .contestant-card .body { padding: .68rem; }
    .pill { display: inline-block; margin-top: .32rem; padding: .16rem .52rem; border-radius: 999px; font-size: .72rem; border: 1px solid transparent; }
    .safe { background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.45); }
    .nominee { background: rgba(245,158,11,.16); border-color: rgba(245,158,11,.42); }
    .saved_judges, .saved_public { background: rgba(59,130,246,.16); border-color: rgba(59,130,246,.42); }
    .eliminated { background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.42); }
    .tbd { background: rgba(148,163,184,.16); border-color: rgba(148,163,184,.42); }
    .row { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 840px) { .row.two { grid-template-columns: 280px 1fr; } }
    .profile-img { width: 100%; max-width: 260px; border-radius: 12px; border: 1px solid var(--line); }
    .btn { text-decoration: none; color: var(--text); border: 1px solid var(--line); background: var(--panel2); border-radius: 10px; padding: .42rem .7rem; display: inline-block; }
    .table-wrap { overflow: auto; }
    table { width: 100%; border-collapse: collapse; font-size: .88rem; }
    th, td { border-bottom: 1px solid var(--line); padding: .5rem .36rem; text-align: left; white-space: nowrap; }
    .table-wrap a { color: var(--text); text-decoration: underline; text-underline-offset: 2px; }
    .table-wrap a:visited { color: var(--text); }
    .chip { display: inline-block; border: 1px solid var(--line); border-radius: 999px; padding: .18rem .52rem; font-size: .74rem; background: rgba(99,102,241,.12); }
    .vote-row { margin-bottom: .72rem; }
    .bar { width: 100%; height: 12px; border: 1px solid var(--line); background: #091224; border-radius: 999px; overflow: hidden; }
    .bar > span { display: block; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  </style>
</head>
<body>
<header>
  <div class="container topbar">
    <div class="brand">
      <h1>Star KCA Academy</h1>
      <p>Contestants · Rankings · Votes</p>
    </div>
    <nav id="nav"></nav>
  </div>
</header>

<main class="container">
  <section id="contestants" class="page active"></section>
  <section id="profile" class="page"></section>
  <section id="rankings" class="page"></section>
  <section id="votes" class="page"></section>
</main>

<script>
const CONFIG = {
  SHEET_ID: "1wllhbdbdIJM3uTI-WnJFE5eJ8zb_scgik5k94Yegc1s",
  SHEETS: {
    contestants: "contestants",
    rounds: "rounds",
    submissions: "submissions",
    scores: "scores",
    judge_rankings: "judge_rankings",
    round_status: "round_status",
    votes_live: "votes_live"
  },
  ROUND_TABS: { PRERANK: "PRERANK", ROUND_1: "R1", ROUND_2: "R2", ROUND_3: "R3", ROUND_4: "R4", ROUND_5: "R5", ROUND_6: "R6", FINAL: "FINAL" },
  VOTE_FORM_URL: "https://docs.google.com/forms/d/e/1FAIpQLSdRAvtdk_e2yVjhhLJmvh6UJhMd4tw6OIzBHkbyLaau7tt8cQ/viewform?usp=header",
  REFRESH_MS: 30000
};

const ROUND_ORDER = ["PRERANK", "ROUND_1", "ROUND_2", "ROUND_3", "ROUND_4", "ROUND_5", "ROUND_6", "FINAL"];
const ROUND_LABELS = { PRERANK: "Prerank", ROUND_1: "R1", ROUND_2: "R2", ROUND_3: "R3", ROUND_4: "R4", ROUND_5: "R5", ROUND_6: "R6", FINAL: "Final" };
const JUDGE_NAMES = ["Neitsu", "Bibiblu", "Kaina", "Hauras", "Cal", "Aya", "(Y)ELLOW", "CAM"];
const CANDIDATE_NAMES = ["yza","hope","lea","megara","asli","chanel","heaven","manuee","hwa_young","mimi","eria","panida","kelsy","suhaa","johi","sun","kora","brahmini","katie","donghyun","lizy","kyo"];
const PRETTY = { yza:'Yza', hope:'Hope', lea:'Lea', megara:'Megara', asli:'Asli', chanel:'Chanel', heaven:'Heaven', manuee:'Manuee', hwa_young:'Hwa Young', mimi:'Mimi', eria:'Eria', panida:'Panida', kelsy:'Kelsy', suhaa:'Suhaa', johi:'Johi', sun:'Sun', kora:'Kora', brahmini:'Brahmini', katie:'Katie', donghyun:'Donghyun', lizy:'Lizy', kyo:'Kyo' };
const ROUND1_NOMINEES = new Set(['brahmini', 'yza', 'donghyun', 'mimi', 'katie', 'kyo']);

const PRERANK_MANUAL_ROWS = [
  { name: 'Asli', instagram: '@aslcvrs', official_rank: 5, score: 89 },
  { name: 'Brahmini', instagram: '@brahmini.vc', official_rank: 18, score: 71 },
  { name: 'Chanel', instagram: '@chgnelx_cover', official_rank: 6, score: 86.5 },
  { name: 'Donghyun', instagram: '@dongnhyu', official_rank: 20, score: 67.5 },
  { name: 'Eria', instagram: '@oyesoowa', official_rank: 11, score: 82.5 },
  { name: 'Heaven', instagram: '@heavens.venture', official_rank: 7, score: 86 },
  { name: 'Hope', instagram: '@ihopeexoo', official_rank: 2, score: 94 },
  { name: 'Hwa Young', instagram: '@hwa_young.kca', official_rank: 9, score: 86 },
  { name: 'Johi', instagram: '@hgn_johi', official_rank: 15, score: 76.5 },
  { name: 'Katie', instagram: '@katiesmelodies', official_rank: 19, score: 71 },
  { name: 'Kelsy', instagram: '@kelsyuniverse', official_rank: 13, score: 80.5 },
  { name: 'Kora', instagram: '@kora_chu0_o', official_rank: 17, score: 75 },
  { name: 'Kyo', instagram: '@kykycovgh', official_rank: 22, score: 60.5 },
  { name: 'Lea', instagram: '@jwleakca', official_rank: 3, score: 91.5 },
  { name: 'Lizy', instagram: '@lizy.off', official_rank: 21, score: 62.5 },
  { name: 'Manuee', instagram: '@_kcamanu', official_rank: 8, score: 86 },
  { name: 'Megara', instagram: '@_megnfique', official_rank: 4, score: 90 },
  { name: 'Mimi', instagram: 'Iwannabemimimi', official_rank: 10, score: 85.5 },
  { name: 'Panida', instagram: '@1stPanidaW', official_rank: 12, score: 82 },
  { name: 'Suhaa', instagram: '@_soobieb00bie_', official_rank: 14, score: 78.5 },
  { name: 'Sun', instagram: '@sun._.kca', official_rank: 16, score: 76.5 },
  { name: 'Yza', instagram: '@yzavliss', official_rank: 1, score: 97.5 }
];

const R1_MANUAL_ROWS = [
  { name: 'Asli', instagram: '@aslcvrs', performance: 'GABRIELA', link: 'https://www.instagram.com/reel/DUp7RDxDMeP/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Brahmini', instagram: '@brahmini.vc', performance: 'SHEESH', link: 'https://www.instagram.com/reel/DUqCB2MjOau/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Chanel', instagram: '@chanelx_cover', performance: 'SUPERSCAR', link: 'https://www.instagram.com/reel/DUqCUs0DHSE/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Donghyun', instagram: '@dongnhyu', performance: 'FAMOUS', link: 'https://www.instagram.com/reel/DUnyzUHjMTz/?igsh=NHF4N21wc29pZm5o' },
  { name: 'Eria', instagram: '@oyesoowa', performance: 'GREEDY', link: 'https://www.instagram.com/reel/DUqVKrcjNH9/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Heaven', instagram: '@heavens.venture', performance: 'ABRACADABRA', link: 'https://www.instagram.com/reel/DUqCHvDjP_E/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Hope', instagram: 'ihopeexo', performance: 'MIDNIGHT SUN', link: 'https://www.instagram.com/reel/DUnzEkfDEv9/?igsh=MTA5ajlpcDQ3a3YzdQ==' },
  { name: 'Hwa Young', instagram: '@hwa_young.kca', performance: 'GABRIELA', link: '' },
  { name: 'Johi', instagram: '@han_johi', performance: 'SHEESH', link: 'https://www.instagram.com/reel/DUqBvFkDDK8/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Katie', instagram: '@katiesmelodies', performance: 'GREEDY', link: 'https://www.instagram.com/reel/DUqBeD_DKXj/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Kelsy', instagram: '@kelsyuniverse', performance: 'GABRIELA', link: 'https://www.instagram.com/reel/DUp7AYdDBbv/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Kora', instagram: '@kora_chu0_o', performance: 'GABRIELA', link: 'https://www.instagram.com/reel/DUp7LKHDN14/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Kyo', instagram: '@kykycovgh', performance: 'SODA POP', link: 'https://www.instagram.com/reel/DUqVftqDK8C/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Lea', instagram: '@jwleakca', performance: 'SUPERSCAR', link: 'https://www.instagram.com/reel/DUk5QK2DC8K/?igsh=aTMyZHRkcGt6NGRv' },
  { name: 'Lizy', instagram: '@lizy.off', performance: 'GREEDY', link: 'https://www.instagram.com/reel/DUqB1jsjA7A/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Manuee', instagram: '@_kcamanu', performance: 'ABRACADABRA', link: 'https://www.instagram.com/reel/DUk44gyDCbp/?igsh=MTQ4anBxajU3ZXUzdw==' },
  { name: 'Megara', instagram: '@_megnifique', performance: 'UNETHICAL', link: 'https://www.instagram.com/reel/DUqBk_XjJmk/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Mimi', instagram: 'Iwannabemimimi', performance: 'SUPERSCAR', link: 'https://www.instagram.com/reel/DUk4g-9DHa5/?igsh=OTJkdm9qa3g1c3B3' },
  { name: 'Panida', instagram: '@1stPanidaW', performance: 'WHERE IS MY HUSBAND', link: 'https://www.instagram.com/reel/DUp79mfDM5e/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Suhaa', instagram: '@_soobieboobie_', performance: 'FAMOUS', link: 'https://www.instagram.com/reel/DUnzQByjHZk/?igsh=MWs4cWJqZWt2ZWN6' },
  { name: 'Sun', instagram: '@sun._.kca', performance: 'MIDNIGHT SUN', link: 'https://www.instagram.com/reel/DUnylisjLqH/?igsh=MWhodXg0cjlyeWpvNg==' },
  { name: 'Yza', instagram: '@yzavliss', performance: 'UNETHICAL', link: '' }
];

let rankingChart = null;
let profileChart = null;

const state = {
  data: { contestants: [], rounds: [], submissions: [], scores: [], judge_rankings: [], round_status: [], votes_live: [] },
  latestRound: "PRERANK",
  rankingView: "official",
  votesRound: "PRERANK",
  votesTimer: null
};

function normId(v) {
  return String(v || "").toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g, '').replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
}

function canonicalRoundId(value) {
  const raw = String(value || '').trim().toUpperCase().replace(/\s+/g, '_').replace(/-/g, '_');
  if (!raw) return '';
  if (ROUND_ORDER.includes(raw)) return raw;
  if (/^R[1-6]$/.test(raw)) return `ROUND_${raw.slice(1)}`;
  if (raw === 'PRE_RANK' || raw === 'PRERANKING') return 'PRERANK';
  if (raw === 'ROUND1') return 'ROUND_1';
  if (raw === 'ROUND2') return 'ROUND_2';
  if (raw === 'ROUND3') return 'ROUND_3';
  if (raw === 'ROUND4') return 'ROUND_4';
  if (raw === 'ROUND5') return 'ROUND_5';
  if (raw === 'ROUND6') return 'ROUND_6';
  return raw;
}

function normalizeJudgeName(v) {
  return String(v || '').trim().toLowerCase();
}

function prettyFromId(id) {
  return PRETTY[id] || String(id || '').replace(/_/g, ' ').replace(/\b\w/g, m => m.toUpperCase());
}

function getContestantName(id) {
  const raw = state.data.contestants.find(c => c.id === id)?.name || '';
  return String(raw || '').trim() || prettyFromId(id);
}

function colorForIndex(i) {
  const hue = (i * 47) % 360;
  return `hsl(${hue} 85% 62%)`;
}

function handleImageFallback(img) {
  const step = Number(img.dataset.fallbackStep || '0');
  const contestantId = String(img.dataset.contestantId || '').trim();
  const canonicalLocal = contestantId ? `assets/${contestantId}.jpg` : '';
  const currentSrc = String(img.getAttribute('src') || '');

  if (step === 0 && canonicalLocal && !currentSrc.endsWith(canonicalLocal)) {
    img.dataset.fallbackStep = '1';
    img.src = canonicalLocal;
    return;
  }

  img.onerror = null;
  img.src = 'assets/placeholder.jpg';
}

async function fetchSheetTab(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const txt = await fetch(url).then(r => r.text());
  const m = txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
  if (!m) throw new Error(`Invalid gviz payload for ${sheetName}`);
  const json = JSON.parse(m[1]);
  const cols = json.table.cols.map(c => c.label || c.id || '');
  return json.table.rows.map(r => Object.fromEntries(cols.map((c, i) => [c, r.c[i]?.v ?? ''])));
}

async function fetchOptionalSheetTab(sheetName) {
  try { return await fetchSheetTab(sheetName); } catch { return []; }
}

function keyNorm(k) { return String(k || '').toLowerCase().replace(/[^a-z0-9]/g, ''); }
function pickValue(row, aliases) {
  const keys = Object.keys(row);
  for (const a of aliases) {
    const n = keyNorm(a);
    const real = keys.find(k => keyNorm(k) === n);
    if (real != null) return row[real];
  }
  return '';
}

async function loadDataFromRoundTabs() {
  const rowsByRound = {};
  for (const [rid, tab] of Object.entries(CONFIG.ROUND_TABS)) {
    rowsByRound[rid] = await fetchOptionalSheetTab(tab);
  }

  const contestantsMap = new Map();
  const judge_rankings = [];
  const scores = [];
  const submissions = [];

  Object.entries(rowsByRound).forEach(([round_id, rows]) => {
    rows.forEach((row) => {
      const name = String(pickValue(row, ['name', 'contestant', 'candidate']) || '').trim();
      if (!name) return;
      const id = normId(name);
      const instagram = String(pickValue(row, ['instagram', 'instagram_handle', 'username']) || '').trim();
      const performance = String(pickValue(row, ['performance', 'song', 'song_title']) || '').trim();
      const link = String(pickValue(row, ['link', 'performance_link', 'youtube_url', 'url']) || '').trim();
      const officialRank = Number(pickValue(row, ['official_rank', 'rank', 'official ranking']));
      const perfScore = Number(pickValue(row, ['performance_score', 'score', 'creator_score', 'total']));

      if (!contestantsMap.has(id)) contestantsMap.set(id, { id, name, photo_url: `assets/${id}.jpg`, country: '', bio: '', instagram, pronouns: '' });
      if (instagram && !contestantsMap.get(id).instagram) contestantsMap.get(id).instagram = instagram;

      if (Number.isFinite(officialRank)) judge_rankings.push({ round_id, judge_name: 'official', contestant_id: id, rank: officialRank });
      if (Number.isFinite(perfScore)) scores.push({ round_id, contestant_id: id, total: perfScore });
      if (performance || link) submissions.push({ round_id, contestant_id: id, song_title: performance, group_song: '', bandlab_url: '', youtube_url: link, notes: '' });

      JUDGE_NAMES.forEach(jn => {
        const val = Number(pickValue(row, [jn, `${jn}_rank`, `${jn} rank`]));
        if (Number.isFinite(val)) judge_rankings.push({ round_id, judge_name: jn, contestant_id: id, rank: val });
      });
    });
  });

  return { contestants: [...contestantsMap.values()], rounds: [], submissions, scores, judge_rankings, round_status: [], votes_live: [] };
}

async function loadData() {
  const standard = {
    contestants: await fetchOptionalSheetTab(CONFIG.SHEETS.contestants),
    rounds: await fetchOptionalSheetTab(CONFIG.SHEETS.rounds),
    submissions: await fetchOptionalSheetTab(CONFIG.SHEETS.submissions),
    scores: await fetchOptionalSheetTab(CONFIG.SHEETS.scores),
    judge_rankings: await fetchOptionalSheetTab(CONFIG.SHEETS.judge_rankings),
    round_status: await fetchOptionalSheetTab(CONFIG.SHEETS.round_status),
    votes_live: await fetchOptionalSheetTab(CONFIG.SHEETS.votes_live)
  };

  const hasStandard = [standard.contestants, standard.scores, standard.judge_rankings, standard.round_status, standard.submissions].some(a => a.length);
  if (hasStandard) {
    state.data = standard;
  } else {
    state.data = await loadDataFromRoundTabs();
    state.data.votes_live = await fetchOptionalSheetTab(CONFIG.SHEETS.votes_live);
  }
}

function normalizeData() {
  const d = state.data;
  d.contestants = Array.isArray(d.contestants) ? d.contestants : [];
  d.rounds = Array.isArray(d.rounds) ? d.rounds : [];
  d.submissions = Array.isArray(d.submissions) ? d.submissions : [];
  d.scores = Array.isArray(d.scores) ? d.scores : [];
  d.judge_rankings = Array.isArray(d.judge_rankings) ? d.judge_rankings : [];
  d.round_status = Array.isArray(d.round_status) ? d.round_status : [];
  d.votes_live = Array.isArray(d.votes_live) ? d.votes_live : [];

  d.contestants = d.contestants.map(r => ({
    id: normId(r.id || r.contestant_id || r.name),
    name: String(r.name || '').trim() || prettyFromId(normId(r.id || r.contestant_id || r.name)),
    photo_url: String(r.photo_url || `assets/${normId(r.id || r.name)}.jpg`),
    country: String(r.country || '').trim(),
    bio: String(r.bio || '').trim(),
    instagram: String(r.instagram || '').trim(),
    pronouns: String(r.pronouns || '').trim()
  })).filter(c => c.id);

  d.submissions = d.submissions.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id) }));
  d.scores = d.scores.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id), total: Number(r.total) }));
  d.judge_rankings = d.judge_rankings.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id), rank: Number(r.rank), judge_name: String(r.judge_name || '').trim() }));
  d.round_status = d.round_status.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id), status: String(r.status || '').trim().toLowerCase() }));
  d.votes_live = d.votes_live.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id), votes_count: Number(r.votes_count || 0) }));
}

function resolveContestantIdByName(name) {
  const slug = normId(name);
  const byId = state.data.contestants.find(c => c.id === slug);
  if (byId) return byId.id;
  const normalized = String(name || '').toLowerCase().replace(/\s+/g, ' ').trim();
  const byName = state.data.contestants.find(c => String(c.name || '').toLowerCase().replace(/\s+/g, ' ').trim() === normalized);
  if (byName) return byName.id;
  return slug;
}

function applyManualPrerankSeed() {
  const hasOfficialPrerank = state.data.judge_rankings.some(r => r.round_id === 'PRERANK' && normalizeJudgeName(r.judge_name) === 'official');
  const hasScorePrerank = state.data.scores.some(r => r.round_id === 'PRERANK' && Number.isFinite(Number(r.total)));

  PRERANK_MANUAL_ROWS.forEach((row) => {
    const id = resolveContestantIdByName(row.name);
    let c = state.data.contestants.find(x => x.id === id);
    if (!c) {
      c = { id, name: row.name, photo_url: `assets/${id}.jpg`, country: '', bio: '', instagram: '', pronouns: '' };
      state.data.contestants.push(c);
    }
    if (!c.instagram && row.instagram) c.instagram = row.instagram;

    if (!hasOfficialPrerank) state.data.judge_rankings.push({ round_id: 'PRERANK', judge_name: 'official', contestant_id: id, rank: row.official_rank });
    if (!hasScorePrerank) state.data.scores.push({ round_id: 'PRERANK', contestant_id: id, total: row.score });
  });
}

function applyManualR1Seed() {
  const hasR1Submissions = state.data.submissions.some(r => r.round_id === 'ROUND_1' && (String(r.song_title || '').trim() || String(r.youtube_url || '').trim() || String(r.bandlab_url || '').trim()));

  R1_MANUAL_ROWS.forEach((row) => {
    const id = resolveContestantIdByName(row.name);
    let c = state.data.contestants.find(x => x.id === id);
    if (!c) {
      c = { id, name: row.name, photo_url: `assets/${id}.jpg`, country: '', bio: '', instagram: '', pronouns: '' };
      state.data.contestants.push(c);
    }
    if (!c.instagram && row.instagram) c.instagram = row.instagram;

    if (!hasR1Submissions && (row.performance || row.link)) {
      state.data.submissions.push({ round_id: 'ROUND_1', contestant_id: id, song_title: row.performance || '', group_song: '', bandlab_url: '', youtube_url: row.link || '', notes: '' });
    }
  });
}

function enforcePrerankSafeStatus() {
  const ids = state.data.contestants.length ? state.data.contestants.map(c => c.id).filter(Boolean) : [...CANDIDATE_NAMES];
  state.data.round_status = state.data.round_status.filter(r => r.round_id !== 'PRERANK');
  ids.forEach(id => state.data.round_status.push({ round_id: 'PRERANK', contestant_id: id, status: 'safe' }));
}

function enforceRound1Statuses() {
  const ids = state.data.contestants.length ? state.data.contestants.map(c => c.id).filter(Boolean) : [...CANDIDATE_NAMES];
  state.data.round_status = state.data.round_status.filter(r => r.round_id !== 'ROUND_1');
  ids.forEach(id => {
    state.data.round_status.push({
      round_id: 'ROUND_1',
      contestant_id: id,
      status: ROUND1_NOMINEES.has(id) ? 'nominee' : 'safe'
    });
  });
}

function getStatus(roundId, contestantId) {
  return state.data.round_status.find(r => r.round_id === roundId && r.contestant_id === contestantId)?.status || '';
}
function statusClass(status) { return status || 'tbd'; }
function statusLabel(status) { return status ? status.replace('_', ' ') : 'TBD'; }

function getOfficialRankingByRound() {
  const out = Object.fromEntries(ROUND_ORDER.map(r => [r, {}]));
  state.data.judge_rankings
    .filter(r => normalizeJudgeName(r.judge_name) === 'official')
    .forEach(r => { if (Number.isFinite(r.rank)) out[r.round_id][r.contestant_id] = r.rank; });

  ROUND_ORDER.forEach(round => {
    if (Object.keys(out[round]).length) return;
    const list = state.data.scores.filter(s => s.round_id === round && Number.isFinite(s.total)).sort((a, b) => b.total - a.total);
    list.forEach((s, i) => out[round][s.contestant_id] = i + 1);
  });
  return out;
}

function getJudgeRankingByRound(judgeName) {
  const key = normalizeJudgeName(judgeName);
  const out = Object.fromEntries(ROUND_ORDER.map(r => [r, {}]));
  state.data.judge_rankings.filter(r => normalizeJudgeName(r.judge_name) === key).forEach(r => { if (Number.isFinite(r.rank)) out[r.round_id][r.contestant_id] = r.rank; });
  return out;
}

function getPerformanceScoreByRound() {
  const out = Object.fromEntries(ROUND_ORDER.map(r => [r, {}]));
  state.data.scores.forEach(s => { if (Number.isFinite(s.total)) out[s.round_id][s.contestant_id] = s.total; });
  return out;
}

function getPerformanceRankByRound() {
  const scoreMap = getPerformanceScoreByRound();
  const out = Object.fromEntries(ROUND_ORDER.map(r => [r, {}]));
  ROUND_ORDER.forEach(round => {
    const rows = Object.entries(scoreMap[round]).sort((a, b) => b[1] - a[1]);
    rows.forEach(([id], i) => out[round][id] = i + 1);
  });
  return out;
}

function getRankingViewOptions() {
  return [
    { value: 'official', label: 'Official ranking' },
    ...JUDGE_NAMES.map(j => ({ value: `judge:${j}`, label: j })),
    { value: 'performance_score', label: 'Performance score' }
  ];
}

function getRankingMapByView(view) {
  if (view === 'official') return getOfficialRankingByRound();
  if (view === 'performance_score') return getPerformanceScoreByRound();
  if (view.startsWith('judge:')) return getJudgeRankingByRound(view.split(':')[1]);
  return getOfficialRankingByRound();
}

function getLatestRound(officialByRound) {
  for (let i = ROUND_ORDER.length - 1; i >= 0; i--) {
    const round = ROUND_ORDER[i];
    const hasOfficial = Object.keys(officialByRound[round] || {}).length > 0;
    const hasStatus = state.data.round_status.some(r => r.round_id === round);
    if (hasOfficial || hasStatus) return round;
  }
  return 'PRERANK';
}

function sortedContestants() {
  const officialByRound = getOfficialRankingByRound();
  const current = officialByRound[state.latestRound] || {};
  return [...state.data.contestants].sort((a, b) => {
    const aStatus = getStatus(state.latestRound, a.id);
    const bStatus = getStatus(state.latestRound, b.id);
    const aElim = aStatus === 'eliminated' ? 1 : 0;
    const bElim = bStatus === 'eliminated' ? 1 : 0;
    if (aElim !== bElim) return aElim - bElim;

    const ar = current[a.id], br = current[b.id];
    if (Number.isFinite(ar) && Number.isFinite(br)) return ar - br;
    if (Number.isFinite(ar)) return -1;
    if (Number.isFinite(br)) return 1;
    return String(a.name || '').localeCompare(String(b.name || ''));
  });
}

function renderContestants() {
  const root = document.getElementById('contestants');
  const officialByRound = getOfficialRankingByRound();
  const currentRanks = officialByRound[state.latestRound] || {};
  root.innerHTML = `
    <div class="card">
      <h2>Contestants</h2>
      <p class="small">Auto-updated from latest available official ranking/status round: <span class="chip">${ROUND_LABELS[state.latestRound]}</span></p>
      <div class="filters">
        <input id="searchContestant" placeholder="Search name..." />
        <select id="statusFilter">
          <option value="all">All status</option>
          <option value="safe">safe</option>
          <option value="nominee">nominee</option>
          <option value="saved_judges">saved judges</option>
          <option value="saved_public">saved public</option>
          <option value="eliminated">eliminated</option>
          <option value="tbd">TBD</option>
        </select>
      </div>
      <div id="contestantsGrid" class="contestants-grid"></div>
    </div>`;

  const draw = () => {
    const q = document.getElementById('searchContestant').value.toLowerCase().trim();
    const f = document.getElementById('statusFilter').value;

    const list = sortedContestants().filter(c => c.name.toLowerCase().includes(q)).filter(c => {
      const status = getStatus(state.latestRound, c.id);
      if (f === 'all') return true;
      if (f === 'tbd') return !status;
      return status === f;
    });

    document.getElementById('contestantsGrid').innerHTML = list.map(c => {
      const status = getStatus(state.latestRound, c.id);
      return `<article class="contestant-card" onclick="location.hash='#profile/${c.id}'">
        <img src="${c.photo_url}" data-contestant-id="${c.id}" alt="${c.name}" onerror="handleImageFallback(this)" />
        <div class="body"><strong>${getContestantName(c.id)}</strong><div class="small">${Number.isFinite(currentRanks[c.id]) ? `Rank ${ROUND_LABELS[state.latestRound]}: #${currentRanks[c.id]}` : `Rank ${ROUND_LABELS[state.latestRound]}: —`}</div><span class="pill ${statusClass(status)}">${statusLabel(status)}</span></div>
      </article>`;
    }).join('') || `<p class="small">No contestants found.</p>`;
  };

  document.getElementById('searchContestant').addEventListener('input', draw);
  document.getElementById('statusFilter').addEventListener('change', draw);
  draw();
}

function renderRankings() {
  const root = document.getElementById('rankings');
  const viewOptions = getRankingViewOptions();
  const rankingMap = getRankingMapByView(state.rankingView);
  const isPerformance = state.rankingView === 'performance_score';

  const list = [...state.data.contestants].sort((a, b) => {
    const av = rankingMap[state.latestRound]?.[a.id];
    const bv = rankingMap[state.latestRound]?.[b.id];
    if (Number.isFinite(av) && Number.isFinite(bv)) return isPerformance ? bv - av : av - bv;
    if (Number.isFinite(av)) return -1;
    if (Number.isFinite(bv)) return 1;
    return a.name.localeCompare(b.name);
  });

  const nominations = {
    nominee: state.data.round_status.filter(r => r.round_id === state.latestRound && r.status === 'nominee'),
    saved_judges: state.data.round_status.filter(r => r.round_id === state.latestRound && r.status === 'saved_judges'),
    saved_public: state.data.round_status.filter(r => r.round_id === state.latestRound && r.status === 'saved_public'),
    eliminated: state.data.round_status.filter(r => r.round_id === state.latestRound && r.status === 'eliminated')
  };

  root.innerHTML = `
    <div class="card">
      <h2>Rankings</h2>
      <div class="filters">
        <select id="rankingViewSelect">${viewOptions.map(o => `<option value="${o.value}" ${o.value===state.rankingView?'selected':''}>${o.label}</option>`).join('')}</select>
      </div>
      <p class="small">Table shows rank trajectory by round. In "Performance score" mode, values are points.</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>${isPerformance ? 'Pos' : 'Rank'}</th>
              <th>Name</th>
              ${ROUND_ORDER.map(r => `<th>${ROUND_LABELS[r]}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            ${list.map((c, idx) => `
              <tr>
                <td>${idx + 1}</td>
                <td><a href="#profile/${c.id}">${getContestantName(c.id)}</a></td>
                ${ROUND_ORDER.map(r => {
                  const v = rankingMap[r]?.[c.id];
                  if (!Number.isFinite(v)) return '<td>—</td>';
                  return `<td>${isPerformance ? v.toFixed(1).replace(/\.0$/, '') : v}</td>`;
                }).join('')}
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
      <h3>Nominations (${ROUND_LABELS[state.latestRound]})</h3>
      <p class="small">Nominee: ${nominations.nominee.map(x => getContestantName(x.contestant_id)).join(', ') || '—'}</p>
      <p class="small">Saved judges: ${nominations.saved_judges.map(x => getContestantName(x.contestant_id)).join(', ') || '—'}</p>
      <p class="small">Saved public: ${nominations.saved_public.map(x => getContestantName(x.contestant_id)).join(', ') || '—'}</p>
      <p class="small">Eliminated: ${nominations.eliminated.map(x => getContestantName(x.contestant_id)).join(', ') || '—'}</p>
    </div>
    <div class="card">
      <h3>Global evolution chart</h3>
      <canvas id="rankingChart" height="120"></canvas>
    </div>`;

  document.getElementById('rankingViewSelect').addEventListener('change', (e) => {
    state.rankingView = e.target.value;
    renderRankings();
  });

  if (rankingChart) rankingChart.destroy();
  const ctx = document.getElementById('rankingChart');
  rankingChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ROUND_ORDER.map(r => ROUND_LABELS[r]),
      datasets: state.data.contestants.map((c, idx) => {
        const color = colorForIndex(idx);
        return {
          label: getContestantName(c.id),
          data: ROUND_ORDER.map(r => {
            const v = rankingMap[r]?.[c.id];
            return Number.isFinite(v) ? v : null;
          }),
          borderColor: color,
          backgroundColor: color,
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 4,
          tension: .25,
          spanGaps: true
        };
      })
    },
    options: {
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: { color: '#eef3ff', boxWidth: 10, usePointStyle: true, pointStyle: 'line' }
        }
      },
      scales: isPerformance
        ? { x: { ticks: { color: '#9aa6c2' } }, y: { ticks: { color: '#9aa6c2' }, title: { display: true, text: 'Performance points', color: '#9aa6c2' } } }
        : { x: { ticks: { color: '#9aa6c2' } }, y: { reverse: true, min: 1, max: Math.max(22, state.data.contestants.length), ticks: { color: '#9aa6c2', stepSize: 1 } } }
    }
  });
}

function renderProfile(contestantId) {
  const c = state.data.contestants.find(x => x.id === contestantId);
  const root = document.getElementById('profile');
  if (!c) { root.innerHTML = `<div class="card"><p>Contestant not found.</p></div>`; return; }

  const official = getOfficialRankingByRound();
  const judgesByName = Object.fromEntries(JUDGE_NAMES.map(j => [j, getJudgeRankingByRound(j)]));
  const perfScore = getPerformanceScoreByRound();
  const perfRank = getPerformanceRankByRound();

  const submissions = state.data.submissions.filter(s => s.contestant_id === c.id).sort((a,b) => ROUND_ORDER.indexOf(a.round_id) - ROUND_ORDER.indexOf(b.round_id));

  const meta = [
    c.country ? `Country: ${c.country}` : '',
    c.pronouns ? `Pronouns: ${c.pronouns}` : '',
    c.instagram ? `Instagram: ${c.instagram}` : ''
  ].filter(Boolean).join(' · ');

  root.innerHTML = `
    <div class="card">
      <a class="btn" href="#contestants">← Back to contestants</a>
      <div class="row two" style="margin-top:.8rem">
        <div>
          <img class="profile-img" src="${c.photo_url}" data-contestant-id="${c.id}" alt="${c.name}" onerror="handleImageFallback(this)" />
        </div>
        <div>
          <h2>${getContestantName(c.id)}</h2>
          ${c.bio ? `<p>${c.bio}</p>` : ''}
          ${meta ? `<p class="small">${meta}</p>` : ''}

          <h3>Rounds overview</h3>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Round</th><th>Official</th>${JUDGE_NAMES.map(j => `<th>${j}</th>`).join('')}<th>Performance score</th><th>Performance rank</th><th>Status</th></tr></thead>
              <tbody>
                ${ROUND_ORDER.map(r => `
                  <tr>
                    <td>${ROUND_LABELS[r]}</td>
                    <td>${official[r]?.[c.id] ?? '—'}</td>
                    ${JUDGE_NAMES.map(j => `<td>${judgesByName[j]?.[r]?.[c.id] ?? '—'}</td>`).join('')}
                    <td>${Number.isFinite(perfScore[r]?.[c.id]) ? perfScore[r][c.id] : '—'}</td>
                    <td>${perfRank[r]?.[c.id] ?? '—'}</td>
                    <td>${statusLabel(getStatus(r, c.id))}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>

          <h3>Performances</h3>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Round</th><th>Song</th><th>Links</th></tr></thead>
              <tbody>
                ${submissions.map(s => `<tr><td>${ROUND_LABELS[s.round_id] || s.round_id}</td><td>${s.song_title || s.group_song || 'TBD'}</td><td>${s.youtube_url ? `<a target="_blank" href="${s.youtube_url}">Link to the Performance</a>` : '—'}${s.bandlab_url ? ` · <a target="_blank" href="${s.bandlab_url}">BandLab</a>` : ''}</td></tr>`).join('') || `<tr><td colspan="3">No performance links yet.</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>Individual evolution chart (official rank)</h3>
      <canvas id="profileChart" height="100"></canvas>
    </div>`;

  if (profileChart) profileChart.destroy();
  profileChart = new Chart(document.getElementById('profileChart'), {
    type: 'line',
    data: {
      labels: ROUND_ORDER.map(r => ROUND_LABELS[r]),
      datasets: [{
        label: getContestantName(c.id),
        data: ROUND_ORDER.map(r => official[r]?.[c.id] ?? null),
        borderColor: '#8b5cf6',
        backgroundColor: 'rgba(139,92,246,.2)',
        borderWidth: 2,
        tension: .25,
        spanGaps: true
      }]
    },
    options: {
      plugins: { legend: { labels: { color: '#eef3ff' } } },
      scales: { x: { ticks: { color: '#9aa6c2' } }, y: { reverse: true, min: 1, max: Math.max(22, state.data.contestants.length), ticks: { color: '#9aa6c2', stepSize: 1 } } }
    }
  });
}

function renderVotes() {
  const root = document.getElementById('votes');
  const roundsWithVotes = ROUND_ORDER.filter(r => state.data.votes_live.some(v => v.round_id === r));
  const selected = canonicalRoundId(state.votesRound);
  state.votesRound = ROUND_ORDER.includes(selected) ? selected : (roundsWithVotes[0] || state.latestRound);

  const nominees = state.data.round_status.filter(r => r.round_id === state.votesRound && r.status === 'nominee').map(r => r.contestant_id);
  const targets = nominees.length ? nominees : [...new Set(state.data.votes_live.filter(v => v.round_id === state.votesRound).map(v => v.contestant_id))];

  const rows = targets.map(id => {
    const record = state.data.votes_live.find(v => v.round_id === state.votesRound && v.contestant_id === id);
    return { id, name: getContestantName(id), votes: Number(record?.votes_count || 0), updated: record?.last_updated || '-' };
  }).sort((a, b) => b.votes - a.votes);

  const totalVotes = rows.reduce((sum, r) => sum + r.votes, 0);

  root.innerHTML = `
    <div class="card">
      <h2>Votes</h2>
      <div class="filters">
        <select id="votesRoundSelect">${ROUND_ORDER.map(r => `<option value="${r}" ${r===state.votesRound?'selected':''}>${ROUND_LABELS[r]}</option>`).join('')}</select>
        ${CONFIG.VOTE_FORM_URL ? `<a class="btn" target="_blank" rel="noopener noreferrer" href="${CONFIG.VOTE_FORM_URL}">Vote now</a>` : ''}
      </div>
      ${rows.length ? rows.map(r => {
        const pct = totalVotes > 0 ? (r.votes / totalVotes) * 100 : 0;
        return `<div class="vote-row"><div><strong>${r.name}</strong> — ${r.votes} votes (${pct.toFixed(1)}%)</div><div class="bar"><span style="width:${pct}%"></span></div></div>`;
      }).join('') : `<p>No vote data for this round yet.</p>${roundsWithVotes.length ? `<p class="small">Available vote rounds: ${roundsWithVotes.map(r => ROUND_LABELS[r]).join(', ')}</p>` : ''}`}
      <p class="small">Total votes: ${totalVotes} · Last refresh: ${new Date().toLocaleString('fr-FR')}</p>
    </div>`;

  document.getElementById('votesRoundSelect').addEventListener('change', (e) => {
    state.votesRound = e.target.value;
    renderVotes();
  });

  clearTimeout(state.votesTimer);
  state.votesTimer = setTimeout(async () => {
    await hydrate();
    renderContestants();
    renderRankings();
    renderVotes();
  }, CONFIG.REFRESH_MS);
}

function setupNav() {
  const nav = document.getElementById('nav');
  const tabs = ['contestants', 'rankings', 'votes'];
  nav.innerHTML = tabs.map(t => `<a class="nav-link" href="#${t}">${t[0].toUpperCase() + t.slice(1)}</a>`).join('');

  const onHash = () => {
    const hash = location.hash || '#contestants';
    const [page] = hash.slice(1).split('/');

    document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
    if (page === 'profile') {
      document.getElementById('profile').classList.add('active');
      renderProfile(hash.split('/')[1]);
    } else {
      const target = document.getElementById(page) ? page : 'contestants';
      document.getElementById(target).classList.add('active');
    }

    document.querySelectorAll('.nav-link').forEach(a => a.classList.toggle('active', a.getAttribute('href') === `#${page}`));
  };

  window.addEventListener('hashchange', onHash);
  onHash();
}

async function hydrate() {
  await loadData();
  normalizeData();
  applyManualPrerankSeed();
  applyManualR1Seed();
  enforcePrerankSafeStatus();
  enforceRound1Statuses();

  const officialByRound = getOfficialRankingByRound();
  state.latestRound = getLatestRound(officialByRound);
  const roundsWithVotes = ROUND_ORDER.filter(r => state.data.votes_live.some(v => v.round_id === r));
  state.votesRound = roundsWithVotes[0] || state.latestRound;
}

async function boot() {
  setupNav();
  await hydrate();
  renderContestants();
  renderRankings();
  renderVotes();
  if (!location.hash) location.hash = '#contestants';
}

boot();
</script>
</body>
</html>
