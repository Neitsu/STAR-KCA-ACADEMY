<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Star KCA Academy</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #090c14;
      --panel: #131b2a;
      --panel-2: #1a2438;
      --text: #edf2ff;
      --muted: #9aa7bd;
      --accent: #8b5cf6;
      --accent-2: #ec4899;
      --line: #2d3b55;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #202c45 0%, #0b1120 40%, #070a12 100%);
    }
    .container { width: min(1120px, 92vw); margin: 0 auto; }
    header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(9, 12, 20, .9);
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(8px);
    }
    .topbar {
      min-height: 66px; display: flex; justify-content: space-between; align-items: center;
      padding: .8rem 0; gap: .8rem; flex-wrap: wrap;
    }
    .brand h1 { margin: 0; font-size: 1.05rem; letter-spacing: .08em; text-transform: uppercase; }
    .brand p { margin: .2rem 0 0; color: var(--muted); font-size: .82rem; }
    nav { display: flex; gap: .5rem; flex-wrap: wrap; }
    .nav-link {
      color: var(--text); text-decoration: none; border: 1px solid var(--line);
      background: var(--panel); border-radius: 999px; padding: .42rem .75rem; font-size: .85rem;
    }
    .nav-link.active { background: linear-gradient(120deg, var(--accent), var(--accent-2)); border-color: transparent; }
    main { padding: 1rem 0 2.5rem; }
    .page { display: none; }
    .page.active { display: block; }
    .card {
      background: linear-gradient(180deg, #1a2438 0%, #111827 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    h2, h3 { margin: .2rem 0 .8rem; }
    .small { color: var(--muted); font-size: .82rem; }
    .filters { display: flex; gap: .6rem; flex-wrap: wrap; margin-bottom: .8rem; }
    input, select {
      background: #0f1626; color: var(--text); border: 1px solid var(--line);
      border-radius: 10px; padding: .5rem .7rem;
    }
    .contestants-grid {
      display: grid; gap: .8rem;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }
    .contestant-card {
      border: 1px solid var(--line); border-radius: 12px; overflow: hidden; cursor: pointer; background: #0f172a;
    }
    .contestant-card img { width: 100%; height: 168px; object-fit: cover; display: block; }
    .contestant-card .body { padding: .7rem; }
    .pill {
      display: inline-block; margin-top: .35rem; font-size: .72rem;
      border-radius: 999px; padding: .16rem .52rem; border: 1px solid transparent;
    }
    .safe { background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.45); }
    .nominee { background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.45); }
    .saved_judges, .saved_public { background: rgba(59,130,246,.16); border-color: rgba(59,130,246,.45); }
    .eliminated { background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.45); }
    .tbd { background: rgba(148,163,184,.15); border-color: rgba(148,163,184,.35); }
    table { width: 100%; border-collapse: collapse; font-size: .88rem; }
    th, td { border-bottom: 1px solid var(--line); padding: .5rem .35rem; text-align: left; white-space: nowrap; }
    .table-wrap { overflow: auto; }
    .round-chip {
      border: 1px solid var(--line); border-radius: 999px; padding: .2rem .55rem; font-size: .74rem;
      color: #dbeafe; background: rgba(59,130,246,.12);
    }
    .row { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 840px) { .row.two { grid-template-columns: 280px 1fr; } }
    .profile-img { width: 100%; max-width: 260px; border-radius: 12px; border: 1px solid var(--line); }
    .btn {
      border: 1px solid var(--line); border-radius: 10px; padding: .45rem .75rem; color: var(--text);
      background: var(--panel-2); text-decoration: none; display: inline-block;
    }
  </style>
</head>
<body>
<header>
  <div class="container topbar">
    <div class="brand">
      <h1>Star KCA Academy</h1>
      <p>Contestants · Rankings · Trajectory</p>
    </div>
    <nav id="nav"></nav>
  </div>
</header>

<main class="container">
  <section id="contestants" class="page active"></section>
  <section id="profile" class="page"></section>
  <section id="rankings" class="page"></section>
</main>

<script>
const CONFIG = {
  SHEET_ID: "PASTE_YOUR_GOOGLE_SHEET_ID",
  SHEETS: {
    contestants: "contestants",
    rounds: "rounds",
    submissions: "submissions",
    scores: "scores",
    judge_rankings: "judge_rankings",
    round_status: "round_status",
    votes_live: "votes_live"
  }
};

const ROUND_ORDER = ["PRERANK", "ROUND_1", "ROUND_2", "ROUND_3", "ROUND_4", "ROUND_5", "ROUND_6", "FINAL"];
const ROUND_LABELS = {
  PRERANK: "Prerank",
  ROUND_1: "R1",
  ROUND_2: "R2",
  ROUND_3: "R3",
  ROUND_4: "R4",
  ROUND_5: "R5",
  ROUND_6: "R6",
  FINAL: "Final"
};

const state = {
  data: { contestants: [], rounds: [], submissions: [], scores: [], judge_rankings: [], round_status: [], votes_live: [] },
  selectedRound: "ROUND_1",
  chart: null
};

const PRETTY_NAMES = { yza:"Yza", hope:"Hope", lea:"Lea", megara:"Megara", asli:"Asli", chanel:"Chanel", heaven:"Heaven", manuee:"Manuee", hwa_young:"Hwa Young", mimi:"Mimi", eria:"Eria", panida:"Panida", kelsy:"Kelsy", suhaa:"Suhaa", johi:"Johi", sun:"Sun", kora:"Kora", brahmini:"Brahmini", katie:"Katie", donghyun:"Donghyun", lizy:"Lizy", kyo:"Kyo" };

async function fetchSheetTab(sheetName) {
  if (!CONFIG.SHEET_ID || CONFIG.SHEET_ID.includes("PASTE")) throw new Error("No sheet id configured");
  const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substring(47, text.length - 2));
  const cols = json.table.cols.map(c => c.label);
  return json.table.rows.map(r => {
    const row = {};
    cols.forEach((col, i) => row[col] = r.c[i]?.v ?? "");
    return row;
  });
}

function localFallbackData() {
  const ids = Object.keys(PRETTY_NAMES);
  const contestants = ids.map((id, idx) => ({
    id,
    name: PRETTY_NAMES[id],
    photo_url: `assets/${id}.jpg`,
    country: "TBD",
    bio: "Profile to be completed.",
    instagram: idx % 2 === 0 ? `@${id}` : "",
    pronouns: ""
  }));

  const scores = [];
  const submissions = [];
  ids.forEach((id, i) => {
    scores.push({ round_id: "ROUND_1", contestant_id: id, total: (94 - i * 1.5).toFixed(1) });
    scores.push({ round_id: "ROUND_2", contestant_id: id, total: (92 - i * 1.4).toFixed(1) });
    submissions.push({ round_id: "ROUND_1", contestant_id: id, song_title: "TBD", group_song: "", bandlab_url: "", youtube_url: "", notes: "" });
  });

  return {
    contestants,
    rounds: ROUND_ORDER.map(r => ({ round_id: r, round_name: ROUND_LABELS[r] })),
    submissions,
    scores,
    judge_rankings: [],
    round_status: [],
    votes_live: []
  };
}

async function loadData() {
  try {
    const all = await Promise.all(Object.entries(CONFIG.SHEETS).map(async ([key, tab]) => [key, await fetchSheetTab(tab)]));
    state.data = Object.fromEntries(all);
  } catch {
    state.data = localFallbackData();
  }
}

function pageFromHash(hash) {
  return hash.startsWith("#profile/") ? "profile" : (hash.replace("#", "") || "contestants");
}

function setPage(hash) {
  const p = pageFromHash(hash);
  document.querySelectorAll(".page").forEach(x => x.classList.toggle("active", x.id === p));
  document.querySelectorAll(".nav-link").forEach(x => x.classList.toggle("active", x.getAttribute("href") === `#${p}`));
  if (p === "profile") renderProfile(hash.split("/")[1]);
}

function setupNav() {
  const pages = ["contestants", "rankings"];
  document.getElementById("nav").innerHTML = pages
    .map(p => `<a class="nav-link" href="#${p}">${p[0].toUpperCase() + p.slice(1)}</a>`)
    .join("");
}

function getStatus(roundId, contestantId) {
  const row = state.data.round_status.find(r => r.round_id === roundId && r.contestant_id === contestantId);
  return row?.status || "";
}

function statusLabel(status) {
  if (!status) return "TBD";
  return status.replace("_", " ");
}

function statusClass(status) {
  return status || "tbd";
}

function renderContestants() {
  const root = document.getElementById("contestants");
  const options = `<option value="all">All status</option><option value="safe">safe</option><option value="nominee">nominee</option><option value="saved_judges">saved judges</option><option value="saved_public">saved public</option><option value="eliminated">eliminated</option><option value="tbd">TBD</option>`;

  root.innerHTML = `
    <div class="card">
      <h2>Contestants</h2>
      <div class="filters">
        <input id="searchContestant" placeholder="Search name..." />
        <select id="filterRound">${ROUND_ORDER.map(r => `<option value="${r}" ${r===state.selectedRound?"selected":""}>${ROUND_LABELS[r]}</option>`).join("")}</select>
        <select id="filterStatus">${options}</select>
      </div>
      <div id="contestantsGrid" class="contestants-grid"></div>
    </div>`;

  const draw = () => {
    state.selectedRound = document.getElementById("filterRound").value;
    const q = document.getElementById("searchContestant").value.toLowerCase().trim();
    const f = document.getElementById("filterStatus").value;
    const list = state.data.contestants.filter(c => c.name.toLowerCase().includes(q)).filter(c => {
      const st = getStatus(state.selectedRound, c.id);
      if (f === "all") return true;
      if (f === "tbd") return !st;
      return st === f;
    });

    document.getElementById("contestantsGrid").innerHTML = list.map(c => {
      const st = getStatus(state.selectedRound, c.id);
      return `<article class="contestant-card" onclick="location.hash='#profile/${c.id}'">
        <img src="${c.photo_url}" alt="${c.name}" onerror="this.src='https://placehold.co/400x300?text=${c.name}'" />
        <div class="body"><strong>${c.name}</strong><div class="small">${c.country || "TBD"}</div><span class="pill ${statusClass(st)}">${statusLabel(st)}</span></div>
      </article>`;
    }).join("") || `<p class="small">No contestants found.</p>`;

    renderRankings();
  };

  document.getElementById("searchContestant").addEventListener("input", draw);
  document.getElementById("filterRound").addEventListener("change", draw);
  document.getElementById("filterStatus").addEventListener("change", draw);
  draw();
}

function scoreMapByRound() {
  const byRound = {};
  ROUND_ORDER.forEach(r => {
    const rows = state.data.scores.filter(s => s.round_id === r).map(s => ({ ...s, total: Number(s.total) })).filter(s => !Number.isNaN(s.total));
    rows.sort((a,b) => b.total - a.total);
    byRound[r] = rows.reduce((acc, row, idx) => { acc[row.contestant_id] = { rank: idx + 1, total: row.total }; return acc; }, {});
  });
  return byRound;
}

function renderRankings() {
  const root = document.getElementById("rankings");
  const byRound = scoreMapByRound();

  const rankingRows = state.data.contestants.map(c => {
    const current = byRound[state.selectedRound][c.id];
    return { contestant: c, currentRank: current?.rank || 9999 };
  }).sort((a,b) => a.currentRank - b.currentRank || a.contestant.name.localeCompare(b.contestant.name));

  const nominations = {
    nominee: state.data.round_status.filter(r => r.round_id === state.selectedRound && r.status === "nominee"),
    saved_judges: state.data.round_status.filter(r => r.round_id === state.selectedRound && r.status === "saved_judges"),
    saved_public: state.data.round_status.filter(r => r.round_id === state.selectedRound && r.status === "saved_public"),
    eliminated: state.data.round_status.filter(r => r.round_id === state.selectedRound && r.status === "eliminated")
  };

  const nameList = (rows) => rows.map(r => state.data.contestants.find(c => c.id === r.contestant_id)?.name || r.contestant_id).join(", ") || "TBD";

  root.innerHTML = `
    <div class="card">
      <h2>Rankings · Trajectory</h2>
      <div class="filters">
        <label class="small">Reference round</label>
        <select id="rankingRound">${ROUND_ORDER.map(r => `<option value="${r}" ${r===state.selectedRound?"selected":""}>${ROUND_LABELS[r]}</option>`).join("")}</select>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              ${ROUND_ORDER.map(r => `<th><span class="round-chip">${ROUND_LABELS[r]}</span></th>`).join("")}
            </tr>
          </thead>
          <tbody>
            ${rankingRows.map((row, idx) => `
              <tr>
                <td>${Number.isFinite(row.currentRank) && row.currentRank < 9999 ? row.currentRank : idx + 1}</td>
                <td>${row.contestant.name}</td>
                ${ROUND_ORDER.map(r => {
                  const rec = byRound[r][row.contestant.id];
                  return `<td>${rec ? `#${rec.rank} · ${rec.total}` : "—"}</td>`;
                }).join("")}
              </tr>`).join("")}
          </tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <h3>Nominations (${ROUND_LABELS[state.selectedRound]})</h3>
      <p><strong>Nominated:</strong> ${nameList(nominations.nominee)}</p>
      <p><strong>Saved by judges:</strong> ${nameList(nominations.saved_judges)}</p>
      <p><strong>Saved by public:</strong> ${nameList(nominations.saved_public)}</p>
      <p><strong>Eliminated:</strong> ${nameList(nominations.eliminated)}</p>
    </div>`;

  document.getElementById("rankingRound").addEventListener("change", (e) => {
    state.selectedRound = e.target.value;
    renderRankings();
    renderContestants();
  });
}

function renderProfile(contestantId) {
  const c = state.data.contestants.find(x => x.id === contestantId) || state.data.contestants[0];
  if (!c) return;

  const scores = state.data.scores.filter(s => s.contestant_id === c.id);
  const subs = state.data.submissions.filter(s => s.contestant_id === c.id);

  document.getElementById("profile").innerHTML = `
    <div class="card"><a class="btn" href="#contestants">← Back to contestants</a></div>
    <div class="card row two">
      <img class="profile-img" src="${c.photo_url}" alt="${c.name}" onerror="this.src='https://placehold.co/400x420?text=${c.name}'" />
      <div>
        <h2>${c.name}</h2>
        <p>${c.bio || "Bio TBD"}</p>
        <p class="small">Country: ${c.country || "TBD"} · Pronouns: ${c.pronouns || "TBD"} · Instagram: ${c.instagram || "TBD"}</p>
      </div>
    </div>
    <div class="card">
      <h3>Scores by round</h3>
      <div class="table-wrap"><table><thead><tr><th>Round</th><th>Total</th><th>Status</th></tr></thead><tbody>
        ${ROUND_ORDER.map(r => {
          const rec = scores.find(s => s.round_id === r);
          const st = getStatus(r, c.id);
          return `<tr><td>${ROUND_LABELS[r]}</td><td>${rec?.total ?? "—"}</td><td>${statusLabel(st)}</td></tr>`;
        }).join("")}
      </tbody></table></div>
    </div>
    <div class="card">
      <h3>Performances</h3>
      <div class="table-wrap"><table><thead><tr><th>Round</th><th>Song</th><th>Links</th></tr></thead><tbody>
      ${subs.map(s => `<tr><td>${ROUND_LABELS[s.round_id] || s.round_id}</td><td>${s.song_title || s.group_song || "TBD"}</td><td>${s.youtube_url ? `<a target="_blank" href="${s.youtube_url}">YouTube</a>` : "—"}${s.bandlab_url ? ` · <a target="_blank" href="${s.bandlab_url}">BandLab</a>` : ""}</td></tr>`).join("") || '<tr><td colspan="3">No performance links yet.</td></tr>'}
      </tbody></table></div>
    </div>
    <div class="card"><h3>Trajectory chart</h3><canvas id="profileChart" height="110"></canvas></div>`;

  const data = ROUND_ORDER.map(r => Number(scores.find(s => s.round_id === r)?.total || null));
  if (state.chart) state.chart.destroy();
  state.chart = new Chart(document.getElementById("profileChart"), {
    type: "line",
    data: { labels: ROUND_ORDER.map(r => ROUND_LABELS[r]), datasets: [{ label: `${c.name} score`, data, borderColor: "#8b5cf6", backgroundColor: "rgba(139,92,246,.2)", tension: .25, spanGaps: true }] },
    options: { plugins: { legend: { labels: { color: "#edf2ff" } } }, scales: { x: { ticks: { color: "#9aa7bd" } }, y: { ticks: { color: "#9aa7bd" }, suggestedMin: 40, suggestedMax: 100 } } }
  });
}

async function boot() {
  setupNav();
  await loadData();
  renderContestants();
  renderRankings();
  setPage(location.hash || "#contestants");
  window.addEventListener("hashchange", () => setPage(location.hash));
}
boot();
</script>
</body>
</html>
