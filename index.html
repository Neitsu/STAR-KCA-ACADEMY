<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>STAR (KCA) ACADEMY — Rankings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box}
    :root{
      --bg:#070b12;
      --bg-soft:#111827;
      --bg-softer:#0b1220;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#4f46e5;
      --accent-soft:rgba(79,70,229,.12);
      --accent-strong:#a855f7;
      --danger:#ef4444;
      --gold:#facc15;
      --up:#22c55e;
      --down:#f97316;
      --card-radius:20px;
      --shadow-soft:0 18px 40px rgba(15,23,42,.7)
    }

    body[data-theme="light"]{
      --bg:#f3f4f6;
      --bg-soft:#ffffff;
      --bg-softer:#e5e7eb;
      --border:#d1d5db;
      --text:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-soft:rgba(37,99,235,.1);
      --accent-strong:#7c3aed;
      --danger:#b91c1c;
      --gold:#ca8a04;
      --up:#16a34a;
      --down:#ea580c;
      background:radial-gradient(circle at top,#e5e7eb 0,#f9fafb 55%,#e5e7eb 100%);
      color:var(--text);
    }
    body[data-theme="light"] .card{
      background:linear-gradient(180deg,#ffffff,#f3f4f6);
      border-color:var(--border);
      box-shadow:0 12px 25px rgba(148,163,184,.4);
    }
    body[data-theme="light"] .table-wrapper{
      background:#ffffff;
      border-color:var(--border);
    }
    body[data-theme="light"] thead{
      background:linear-gradient(90deg,#e5e7eb,#f3f4f6);
    }
    body[data-theme="light"] tbody tr,
    body[data-theme="light"] tbody tr:nth-child(2n){
      background:#ffffff;
    }
    body[data-theme="light"] tbody tr:hover{
      background:#e5e7eb;
    }
    body[data-theme="light"] tbody tr.selected{
      background:linear-gradient(90deg,#e0f2fe,#ede9fe);
    }
    body[data-theme="light"] .chart-wrap{
      background:linear-gradient(180deg,#ffffff,#e5e7eb);
      border-color:var(--border);
    }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:radial-gradient(circle at top,#1d2537 0,#020617 55%,#000 100%);
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing:antialiased
    }
    main{padding:24px 16px 40px}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    .logo{
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:.9rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:10px
    }
    .logo span{
      display:inline-flex;
      padding:4px 10px;
      border-radius:999px;
      background:linear-gradient(120deg,#a855f7,#4f46e5);
      color:#0f172a;
      font-size:.75rem;
      box-shadow:0 12px 30px rgba(88,28,135,.7)
    }
    h1{
      margin:.4rem 0 0;
      font-size:1.9rem;
      letter-spacing:.04em;
      text-transform:uppercase
    }
    .subtitle{
      margin-top:.4rem;
      font-size:.9rem;
      color:var(--muted)
    }
    .subtitle strong{color:var(--gold)}
    .grid{
      display:grid;
      grid-template-columns:2.4fr 1.8fr;
      gap:24px;
      margin-top:24px
    }
    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:radial-gradient(circle at top left,#1f2937 0,rgba(15,23,42,.9) 55%,#020617 100%);
      border-radius:var(--card-radius);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:var(--shadow-soft);
      padding:18px 18px 16px;
      position:relative;
      overflow:hidden
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.08),transparent 55%);
      opacity:.7;
      pointer-events:none
    }
    .card>div,.card>header{position:relative;z-index:1}
    .card header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:12px
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#e5e7eb
    }
    body[data-theme="light"] .card-title{color:#111827;}
    .card-subtitle{
      font-size:.8rem;
      color:var(--muted)
    }
    .pill{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.5);
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:#e5e7eb
    }
    body[data-theme="light"] .pill{
      background:#e5e7eb;
      color:#111827;
      border-color:#cbd5f5;
    }
    .pill span.dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#22c55e 0,#16a34a 40%,#0f766e 100%);
      box-shadow:0 0 10px rgba(34,197,94,.7)
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:8px
    }
    .toolbar-left{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .toolbar-right{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
    .field{
      position:relative;
      display:flex;
      align-items:center;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
      padding:0 10px;
      min-height:32px;
      font-size:.8rem;
      color:var(--muted);
      gap:6px
    }
    body[data-theme="light"] .field{
      background:#f9fafb;
      border-color:#d1d5db;
      color:#6b7280;
    }
    .field input,.field select{
      background:transparent;
      border:none;
      outline:none;
      color:inherit;
      font:inherit
    }
    .field input::placeholder{color:#6b7280}
    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      padding:6px 12px;
      font-size:.75rem;
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:.12em;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,transform .1s ease
    }
    .btn-ghost{background:transparent;border-color:rgba(51,65,85,.9);color:var(--muted)}
    .btn-primary{
      background:linear-gradient(135deg,#4f46e5,#7c3aed);
      border-color:rgba(129,140,248,.9);
      color:#e5e7eb;
      box-shadow:0 10px 25px rgba(55,48,163,.7)
    }
    .btn:hover{transform:translateY(-1px);border-color:#e5e7eb}
    .btn-primary:hover{background:linear-gradient(135deg,#6366f1,#a855f7)}
    body[data-theme="light"] .btn-ghost{
      border-color:#d1d5db;
      color:#4b5563;
    }
    body[data-theme="light"] .btn-primary{
      background:linear-gradient(135deg,#2563eb,#7c3aed);
      color:#f9fafb;
    }
    .seg{
      display:inline-flex;
      background:rgba(15,23,42,.9);
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      padding:2px
    }
    .seg button{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:4px 9px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      min-width:0
    }
    .seg button.active{
      background:rgba(79,70,229,.15);
      color:#e5e7eb
    }
    body[data-theme="light"] .seg{
      background:#f3f4f6;
      border-color:#d1d5db;
    }
    body[data-theme="light"] .seg button.active{
      background:#e5e7eb;
      color:#111827;
    }

    .menu-root{position:relative;display:flex;align-items:center;gap:8px}
    .menu-btn{display:none}
    .menu-panel{display:flex;flex-wrap:wrap;gap:8px;align-items:center}

    .table-wrapper{
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,.95);
      background:radial-gradient(circle at top,#020617 0,#020617 50%,#000 100%);
      overflow-x:auto;
      overflow-y:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
      min-width:1100px;
    }
    thead{
      background:linear-gradient(90deg,rgba(15,23,42,.98),rgba(17,24,39,.98));
      position:relative
    }
    thead::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 0 0,rgba(129,140,248,.18),transparent 55%);
      opacity:.7;
      pointer-events:none
    }
    thead th{
      text-align:left;
      font-weight:500;
      padding:8px 10px;
      border-bottom:1px solid rgba(55,65,81,.95);
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:.68rem;
      white-space:nowrap
    }
    thead th.num{
      text-align:center;
    }

    th.sticky-rank{
      position:sticky;
      left:0;
      z-index:5;
      background:inherit;
    }
    th.sticky-col{
      position:sticky;
      left:50px;
      z-index:4;
      background:inherit;
      width:125px;
      max-width:125px;
    }

    tbody tr{
      border-bottom:1px solid rgba(31,41,55,.85);
      background:linear-gradient(90deg,rgba(15,23,42,.92),rgba(15,23,42,.9));
      cursor:pointer;
      transition:background .12s ease,transform .06s ease
    }
    tbody tr:nth-child(2n){background:linear-gradient(90deg,rgba(15,23,42,.92),rgba(15,23,42,.94))}
    tbody tr:hover{background:rgba(30,64,175,.35)}
    tbody tr.selected{
      background:radial-gradient(circle at 0 0,rgba(129,140,248,.45),rgba(30,64,175,.85));
      transform:translateY(-1px)
    }
    tbody tr.row-elim{opacity:0.8;}
    tbody td{
      padding:7px 10px;
      vertical-align:middle
    }
    td.rank{
      width:50px;
      font-weight:600;
      color:var(--muted);
      font-variant-numeric:tabular-nums;
      text-align:center;
    }
    td.rank.sticky-rank{
      position:sticky;
      left:0;
      z-index:3;
      background:inherit;
    }
    td.num{
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    td.name{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:500;
      position:relative;
      z-index:3;
      white-space:nowrap;
      min-width:0;
    }
    td.name .name-wrap{
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
      flex:1;
    }
    td.name .name-text{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }
    td.name.sticky-col{
      position:sticky;
      left:50px;
      background:inherit;
      box-shadow:8px 0 12px rgba(15,23,42,.9);
      width:125px;
      max-width:125px;
    }
    body[data-theme="light"] td.name.sticky-col{
      box-shadow:8px 0 12px rgba(209,213,219,.9);
    }
    .avatar{
      width:26px;
      height:26px;
      border-radius:999px;
      object-fit:cover;
      border:1px solid rgba(148,163,184,.75);
      box-shadow:0 6px 16px rgba(15,23,42,.8)
    }
    .chip{
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted)
    }
    body[data-theme="light"] .chip{
      background:#f3f4f6;
      border-color:#d1d5db;
      color:#6b7280;
    }
    .chip.elim{
      border-color:rgba(248,113,113,.7);
      color:#fecaca;
      background:rgba(127,29,29,.7)
    }
    .delta{
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
      font-size:.75rem;
      color:var(--muted);
      margin-left:auto;
    }
    .delta.up{color:var(--up)}
    .delta.down{color:var(--down)}
    .mini{
      margin-top:14px;
      font-size:.75rem;
      color:var(--muted);
      line-height:1.4
    }
    .profile{
      display:flex;
      flex-direction:column;
      gap:12px
    }
    .profile-main{
      display:flex;
      gap:12px;
      align-items:center
    }
    .profile-pic-wrap{
      position:relative;
      width:88px;
      height:88px;
      border-radius:24px;
      padding:2px;
      background:conic-gradient(from 210deg,#4f46e5,#a855f7,#22c55e,#4f46e5);
      box-shadow:0 18px 45px rgba(15,23,42,.9)
    }
    .profile-pic-inner{
      position:relative;
      width:100%;
      height:100%;
      border-radius:inherit;
      overflow:hidden;
      background:radial-gradient(circle at top,#1f2937,#020617)
    }
    .profile-pic-inner img{
      width:100%;
      height:100%;
      object-fit:cover
    }
    .profile-text h2{
      margin:0;
      font-size:1.1rem;
      letter-spacing:.04em;
      text-transform:uppercase
    }
    .profile-text p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:.8rem
    }
    .badge-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px
    }
    .badge{
      font-size:.7rem;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      background:rgba(15,23,42,.9);
      color:var(--muted)
    }
    .badge.gold{
      border-color:rgba(250,204,21,.7);
      color:var(--gold);
      background:rgba(23,37,84,.9)
    }
    body[data-theme="light"] .badge{
      background:#f3f4f6;
      border-color:#d1d5db;
      color:#4b5563;
    }
    body[data-theme="light"] .badge.gold{
      background:#fef3c7;
      border-color:#fbbf24;
      color:#92400e;
    }
    .chart-wrap{
      margin-top:6px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,.9);
      background:radial-gradient(circle at top,#020617,#000);
      padding:10px;
      height:260px;
      position:relative
    }
    .chart-wrap::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 20% 0,rgba(59,130,246,.22),transparent 55%);
      opacity:.7;
      pointer-events:none
    }
    .chart-wrap>canvas{position:relative;z-index:1}
    .sr{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0
    }

    .table-input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:inherit;
      font:inherit;
      text-align:center;
    }
    .table-input::placeholder{
      color:var(--muted);
      opacity:0.6;
    }

    @media(max-width:650px){
      h1{font-size:1.35rem}
      .container{padding:12px}
      .card{padding:14px}
      .toolbar{gap:8px}
      .field{min-height:30px}
      .menu-btn{display:inline-flex}
      .menu-panel{
        display:none;
        position:absolute;
        right:0;
        top:calc(100% + 8px);
        padding:10px;
        border-radius:16px;
        border:1px solid rgba(148,163,184,.35);
        background:rgba(2,6,23,.95);
        box-shadow:0 18px 40px rgba(15,23,42,.8);
        z-index:50;
        min-width:220px;
      }
      body[data-theme="light"] .menu-panel{
        background:rgba(255,255,255,.98);
        border-color:#d1d5db;
        box-shadow:0 16px 30px rgba(148,163,184,.35);
      }
      .menu-panel.open{display:flex;flex-direction:column;align-items:stretch}
      .menu-panel .btn{justify-content:center}
      .seg{
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        scrollbar-width:thin;
        padding-bottom:2px;
        width:100%;
      }
      .seg::-webkit-scrollbar{height:6px;}
      table{
        font-size:.78rem;
        min-width:980px;
      }
      .profile-main{align-items:flex-start}
      #chartLine{height:320px !important}
    }
  </style>
</head>
<body data-theme="dark">
  <main>
    <header class="container">
      <div class="logo">
        <span>STAR (KCA) ACADEMY</span>
        ROUNDS DASHBOARD
      </div>
      <h1>STAR (KCA) ACADEMY — RANKINGS</h1>
    </header>

    <div class="container">
      <div class="grid">
        <div class="card">
          <header>
            <div>
              <div class="card-title">Top contestants</div>
              <div class="card-subtitle">Filter by stage, source, and season.</div>
            </div>
            <div class="pill">
              <span class="dot"></span>
              Live ranking
            </div>
          </header>

          <div class="toolbar">
            <div class="toolbar-left">
              <div class="field" style="min-width:190px">
                <input id="q" type="search" placeholder="Search a contestant..." />
              </div>

              <label class="sr" for="promo">Season</label>
              <select id="promo" aria-label="Filter by season"></select>

              <label class="sr" for="prime">Stage</label>
              <select id="prime" aria-label="Active stage">
                <option value="auto">Auto (latest stage)</option>
                <option value="0">PRERANK</option>
                <option value="1">ROUND 1</option>
                <option value="2">ROUND 2</option>
                <option value="3">ROUND 3</option>
                <option value="4">ROUND 4</option>
                <option value="5">ROUND 5</option>
                <option value="6">ROUND 6</option>
                <option value="7">FINAL</option>
              </select>

            <label class="sr" for="viewSelect">Ranking source</label>
<select id="viewSelect" aria-label="Ranking source" class="view-select">
  <option value="rank">RANK</option>
  <option value="neitsu">NEITSU</option>
  <option value="hauras">HAURAS</option>
  <option value="bibi_blu">BIBI BLU</option>
  <option value="kaina">KAINA</option>
  <option value="cal">CAL</option>
  <option value="aya">AYA</option>
  <option value="score">SCORE</option>
</select>
</div>
            <div class="toolbar-right">
              <div class="menu-root">
                <button id="menuBtn" class="btn btn-ghost menu-btn" type="button" aria-haspopup="true" aria-expanded="false">
                  MENU ▾
                </button>
                <div id="menuPanel" class="menu-panel" role="menu" aria-label="Actions menu">
                  <button id="modeToggle" class="btn btn-ghost" type="button" role="menuitem">EDIT MODE</button>
                  <button id="sortBtn" class="btn btn-ghost" type="button" role="menuitem">SORT BY NAME</button>
                  <button id="toggleElimBtn" class="btn btn-ghost" type="button" role="menuitem">HIDE ELIMINATED</button>
                  <button id="share" class="btn btn-primary" type="button" role="menuitem">COPY LINK</button>
                  <button id="themeToggle" class="btn btn-ghost" type="button" role="menuitem">LIGHT MODE</button>
                </div>
              </div>
            </div>
          </div>

          <div class="table-wrapper">
            <table id="top">
              <thead>
                <tr>
                  <th class="sticky-rank">#</th>
                  <th class="sticky-col">Contestant</th>
                  <th class="num" data-prime="0">PRERANK</th>
                  <th class="num" data-prime="1">ROUND 1</th>
                  <th class="num" data-prime="2">ROUND 2</th>
                  <th class="num" data-prime="3">ROUND 3</th>
                  <th class="num" data-prime="4">ROUND 4</th>
                  <th class="num" data-prime="5">ROUND 5</th>
                  <th class="num" data-prime="6">ROUND 6</th>
                  <th class="num" data-prime="7">FINAL</th>
                  <th class="num">Average</th>
                </tr>
              </thead>
              <tbody id="topBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <header>
            <div>
              <div class="card-title">Contestant profile & chart</div>
              <div class="card-subtitle">Click a contestant to see their trajectory.</div>
            </div>
          </header>

          <div class="profile">
            <div class="profile-main">
              <div class="profile-pic-wrap">
                <div class="profile-pic-inner">
                  <img id="pic" src="assets/placeholder.jpg" alt="Selected contestant" />
                </div>
              </div>
              <div class="profile-text">
                <h2 id="infoName">No contestant selected</h2>
                <p id="infoPromo">Season —</p>
                <div class="badge-row">
                  <span class="badge gold">Active stage</span>
                  <span class="badge">RANK / NEITSU / HAURAS / BIBI BLU / KAINA / CAL / AYA / SCORE</span>
                </div>
                <p id="infoExtra" style="margin-top:6px;font-size:.8rem;color:var(--muted);max-width:280px;">
                  Rank, average and elimination status will appear here.
                </p>

                <div id="elimEditor" style="margin-top:8px;font-size:.8rem;display:none;">
                  <label style="display:inline-flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="elimCheckbox" />
                    Eliminated
                  </label>
                  <select id="elimPrime" style="margin-left:8px;">
                    <option value="">Stage ?</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="chart-wrap">
              <canvas id="chartLine"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="container">
      <p class="mini">
        Δ places = rank difference compared to previous stage (▲ = better, ▼ = worse). Click a contestant to view details.
        Use <strong>viewer=1</strong> in the URL to share a view-only link.
      </p>
    </footer>
  </main>

  <script>
    "use strict";

    const IS_VIEWER = new URLSearchParams(location.search).get("viewer") === "1";

    /*********************************
     * 1. Ranking data (empty by default)
     *********************************/

    const baseEleves = [
      { id:1, nom: "Heaven", promo: "KCA 2026", img: "assets/heaven.jpg", eliminatedAt: null },
      { id:2, nom: "Manuee", promo: "KCA 2026", img: "assets/manuee.jpg", eliminatedAt: null },
      { id:3, nom: "Donghyun", promo: "KCA 2026", img: "assets/donghyun.jpg", eliminatedAt: null },
      { id:4, nom: "Suhaa", promo: "KCA 2026", img: "assets/suhaa.jpg", eliminatedAt: null },
      { id:5, nom: "Asli", promo: "KCA 2026", img: "assets/asli.jpg", eliminatedAt: null },
      { id:6, nom: "Hwa Young", promo: "KCA 2026", img: "assets/hwa_young.jpg", eliminatedAt: null },
      { id:7, nom: "Kelsy", promo: "KCA 2026", img: "assets/kelsy.jpg", eliminatedAt: null },
      { id:8, nom: "Lizy", promo: "KCA 2026", img: "assets/lizy.jpg", eliminatedAt: null },
      { id:9, nom: "Eria", promo: "KCA 2026", img: "assets/eria.jpg", eliminatedAt: null },
      { id:10, nom: "Sun", promo: "KCA 2026", img: "assets/sun.jpg", eliminatedAt: null },
      { id:11, nom: "Johi", promo: "KCA 2026", img: "assets/johi.jpg", eliminatedAt: null },
      { id:12, nom: "Kyo", promo: "KCA 2026", img: "assets/kyo.jpg", eliminatedAt: null },
      { id:13, nom: "Chanel", promo: "KCA 2026", img: "assets/chanel.jpg", eliminatedAt: null },
      { id:14, nom: "Lea", promo: "KCA 2026", img: "assets/lea.jpg", eliminatedAt: null },
      { id:15, nom: "Mimi", promo: "KCA 2026", img: "assets/mimi.jpg", eliminatedAt: null },
      { id:16, nom: "Megara", promo: "KCA 2026", img: "assets/megara.jpg", eliminatedAt: null },
      { id:17, nom: "Yza", promo: "KCA 2026", img: "assets/yza.jpg", eliminatedAt: null },
      { id:18, nom: "Panida", promo: "KCA 2026", img: "assets/panida.jpg", eliminatedAt: null },
      { id:19, nom: "Brahmini", promo: "KCA 2026", img: "assets/brahmini.jpg", eliminatedAt: null },
      { id:20, nom: "Hope", promo: "KCA 2026", img: "assets/hope.jpg", eliminatedAt: null },
      { id:21, nom: "Katie", promo: "KCA 2026", img: "assets/katie.jpg", eliminatedAt: null },
      { id:22, nom: "Kora", promo: "KCA 2026", img: "assets/kora.jpg", eliminatedAt: null },
    ];

    const VIEW_KEYS = ["rank","neitsu","hauras","bibi_blu","kaina","cal","aya","score"];

    function blankRanks(){
      const o = {};
      for(let p=0;p<=7;p++) o["p"+p] = null;
      return o;
    }

    // Full working dataset = baseEleves + empty rankings per view
    let eleves = baseEleves.map(e => {
      const obj = {
        id: e.id,
        nom: e.nom,
        promo: e.promo,
        img: e.img || "assets/placeholder.jpg",
        eliminatedAt: e.eliminatedAt ?? null
      };
      VIEW_KEYS.forEach(k => obj[k] = blankRanks());
      return obj;
    });

    const MAX_PRIME = 7;

    /*********************************
     * 2. DOM refs
     *********************************/
    const dom = {
      q: document.getElementById("q"),
      promo: document.getElementById("promo"),
      prime: document.getElementById("prime"),
      viewSelect: document.getElementById("viewSelect"),
      topBody: document.getElementById("topBody"),
      pic: document.getElementById("pic"),
      infoName: document.getElementById("infoName"),
      infoPromo: document.getElementById("infoPromo"),
      infoExtra: document.getElementById("infoExtra"),
      elimEditor: document.getElementById("elimEditor"),
      elimCheckbox: document.getElementById("elimCheckbox"),
      elimPrime: document.getElementById("elimPrime"),
      modeToggle: document.getElementById("modeToggle"),
      sortBtn: document.getElementById("sortBtn"),
      toggleElimBtn: document.getElementById("toggleElimBtn"),
      share: document.getElementById("share"),
      themeToggle: document.getElementById("themeToggle"),
      menuBtn: document.getElementById("menuBtn"),
      menuPanel: document.getElementById("menuPanel")
    };

    const appState = {
      view: "rank",
      selectedId: null,
      isEditMode: false,
      sortByName: false,
      hideElim: false,
      activePrime: "auto"
    };

    /*********************************
     * 3. URL params
     *********************************/
    function readParams(){
      const p = new URLSearchParams(location.search);
      const view = p.get("view");
      const promo = p.get("promo");
      const prime = p.get("prime");
      const hideElim = p.get("hideElim");
      if(view && VIEW_KEYS.includes(view)) appState.view = view;
      if(promo) appState.promo = promo;
      if(prime != null) appState.activePrime = prime;
      if(hideElim === "1") appState.hideElim = true;
    }
    function writeParamsToURL(){
      const p = new URLSearchParams(location.search);
      if (appState.view && appState.view !== "rank") p.set("view", appState.view); else p.delete("view");
      const promo = dom.promo.value || "";
      if (promo && promo !== "all") p.set("promo", promo); else p.delete("promo");
      const prime = dom.prime.value || "auto";
      if (prime && prime !== "auto") p.set("prime", prime); else p.delete("prime");
      if (appState.hideElim) p.set("hideElim","1"); else p.delete("hideElim");
      if (IS_VIEWER) p.set("viewer","1");
      const qs = p.toString();
      const url = qs ? `${location.pathname}?${qs}` : location.pathname;
      history.replaceState({}, "", url);
    }

    /*********************************
     * 4. Storage
     *********************************/
    function loadSavedData(){
      try{
        const raw = localStorage.getItem("kcaDataV1");
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.eleves)) return;

        const byId = new Map(eleves.map(e => [e.id, e]));
        parsed.eleves.forEach(saved => {
          const target = byId.get(saved.id);
          if(!target) return;
          target.eliminatedAt = saved.eliminatedAt ?? null;
          if (typeof VIEW_KEYS !== "undefined") {
            VIEW_KEYS.forEach(k => {
              if (saved[k]) Object.assign(target[k], saved[k]);
            });
          }
        });
      }catch(e){
        console.warn("Could not read localStorage", e);
      }
    }
    function saveData() {
      const payload = {
        version: 1,
        eleves: eleves.map(e => {
          const o = { id: e.id, eliminatedAt: e.eliminatedAt ?? null };
          if (typeof VIEW_KEYS !== "undefined") VIEW_KEYS.forEach(k => { o[k] = e[k]; });
          return o;
        })
      };
      try {
        localStorage.setItem("kcaDataV1", JSON.stringify(payload));
      } catch (e) {
        console.warn("Could not write localStorage", e);
      }
    }

    /*********************************
     * 5. Helpers
     *********************************/
    const labels = ["PRERANK","ROUND 1","ROUND 2","ROUND 3","ROUND 4","ROUND 5","ROUND 6","FINAL"];
    function getLabelList(){ return labels.slice(); }

    function mean(nums){
      if(!nums.length) return null;
      return nums.reduce((a,b)=>a+b,0)/nums.length;
    }

    function averageUpTo(eleve, view, maxPrime){
      const vals = [];
      for(let p=0;p<=maxPrime;p++){
        const v = eleve[view]["p"+p];
        if(v != null && v !== "" && !Number.isNaN(+v)) vals.push(+v);
      }
      return mean(vals);
    }

    function maxAvailablePrime() {
      let max = 0;
      eleves.forEach(e => {
        for (let p = 0; p <= MAX_PRIME; p++) {
          const key = "p" + p;
          const any = (typeof VIEW_KEYS !== "undefined")
            ? VIEW_KEYS.some(v => e[v] && e[v][key] != null)
            : false;
          if (any && p > max) max = p;
        }
      });
      return max;
    }

    function getActivePrimeNumber(){
      const v = dom.prime.value;
      if(v === "auto"){
        return maxAvailablePrime();
      }
      const n = parseInt(v,10);
      return Number.isFinite(n) ? n : 0;
    }

    function computeRows(){
      const q = (dom.q.value || "").trim().toLowerCase();
      const season = dom.promo.value || "all";
      const view = appState.view;
      const maxP = getActivePrimeNumber();

      let list = eleves.slice();

      if(season !== "all"){
        list = list.filter(e => e.promo === season);
      }
      if(q){
        list = list.filter(e => e.nom.toLowerCase().includes(q));
      }
      if(appState.hideElim){
        list = list.filter(e => e.eliminatedAt == null);
      }

      const rows = list.map(e => {
        const avg = averageUpTo(e, view, maxP);
        return { e, avg };
      });

      rows.sort((a,b)=>{
        const av = a.avg;
        const bv = b.avg;
        const aHas = av != null;
        const bHas = bv != null;
        if(aHas && !bHas) return -1;
        if(!aHas && bHas) return 1;
        if(!aHas && !bHas) return a.e.nom.localeCompare(b.e.nom);

        if(view === "score"){
          if(bv !== av) return bv - av; // higher score = better
        }else{
          if(av !== bv) return av - bv; // lower rank = better
        }
        return a.e.nom.localeCompare(b.e.nom);
      });

      return { rows, maxP, view };
    }

    function deltaBetween(eleve, view, prime){
      if(prime <= 0) return null;
      const a = eleve[view]["p"+prime];
      const b = eleve[view]["p"+(prime-1)];
      if(a==null || b==null) return null;
      const da = +b - +a; // positive means improved if ranks
      if(view === "score") return (+a - +b); // positive means improved score
      return da;
    }

    /*********************************
     * 6. Render table
     *********************************/
    function renderTable(){
      const { rows, maxP, view } = computeRows();
      dom.topBody.innerHTML = "";

      const stageLabels = getLabelList();

      rows.forEach((r, idx) => {
        const e = r.e;
        const tr = document.createElement("tr");
        if(appState.selectedId === e.id) tr.classList.add("selected");
        if(e.eliminatedAt != null) tr.classList.add("row-elim");

        tr.addEventListener("click", () => {
          appState.selectedId = e.id;
          renderAll();
        });

        // Rank #
        const tdRank = document.createElement("td");
        tdRank.className = "rank sticky-rank";
        tdRank.textContent = String(idx + 1);
        tr.appendChild(tdRank);

        // Name
        const tdName = document.createElement("td");
        tdName.className = "name sticky-col";
        const wrap = document.createElement("div");
        wrap.className = "name-wrap";
        const img = document.createElement("img");
        img.className = "avatar";
        img.src = e.img || "assets/placeholder.jpg";
        img.alt = e.nom;
        const nm = document.createElement("span");
        nm.className = "name-text";
        nm.textContent = e.nom;

        wrap.appendChild(img);
        wrap.appendChild(nm);

        // delta
        const d = deltaBetween(e, view, maxP);
        const delta = document.createElement("span");
        delta.className = "delta";
        if(d != null && d !== 0){
          if(d > 0) delta.classList.add("up");
          if(d < 0) delta.classList.add("down");
          const arrow = d > 0 ? "▲" : "▼";
          delta.textContent = `${arrow} ${Math.abs(d)}`;
        }else{
          delta.textContent = "";
        }

        tdName.appendChild(wrap);

        if(e.eliminatedAt != null){
          const chip = document.createElement("span");
          chip.className = "chip elim";
          chip.textContent = "ELIMINATED";
          tdName.appendChild(chip);
        }

        tdName.appendChild(delta);
        tr.appendChild(tdName);

        // Stages columns 0..7
        for(let p=0;p<=MAX_PRIME;p++){
          const td = document.createElement("td");
          td.className = "num";

          const key = "p"+p;
          const val = e[view][key];

          if(appState.isEditMode && !IS_VIEWER){
            const inp = document.createElement("input");
            inp.type = "number";
            inp.className = "table-input";
            inp.placeholder = "—";
            inp.value = (val==null) ? "" : String(val);
            inp.addEventListener("click", ev => ev.stopPropagation());
            inp.addEventListener("input", () => {
              const v = inp.value;
              e[view][key] = (v === "" ? null : Number(v));
              saveData();
              renderAll(false); // do not reset focus
            });
            td.appendChild(inp);
          }else{
            td.textContent = (val==null) ? "—" : String(val);
          }
          tr.appendChild(td);
        }

        // Average
        const tdAvg = document.createElement("td");
        tdAvg.className = "num";
        const avg = averageUpTo(e, view, maxP);
        if(avg == null){
          tdAvg.textContent = "—";
        }else{
          tdAvg.textContent = (view === "score") ? avg.toFixed(1) : avg.toFixed(2);
        }
        tr.appendChild(tdAvg);

        dom.topBody.appendChild(tr);
      });

      highlightActivePrime(maxP);
    }

    function highlightActivePrime(activeP){
      document.querySelectorAll("#top thead th[data-prime]").forEach(th => {
        const p = parseInt(th.getAttribute("data-prime"),10);
        th.style.color = (p === activeP) ? "var(--gold)" : "var(--muted)";
      });
    }

    /*********************************
     * 7. Profile + chart
     *********************************/
    let chart = null;

    function renderProfile(){
      const e = eleves.find(x => x.id === appState.selectedId);
      const view = appState.view;

      if(!e){
        dom.pic.src = "assets/placeholder.jpg";
        dom.infoName.textContent = "No contestant selected";
        dom.infoPromo.textContent = "Season —";
        dom.infoExtra.textContent = "Rank, average and elimination status will appear here.";
        dom.elimEditor.style.display = "none";
        renderChart(null);
        return;
      }

      dom.pic.src = e.img || "assets/placeholder.jpg";
      dom.infoName.textContent = e.nom;
      dom.infoPromo.textContent = "Season " + e.promo;

      const maxP = getActivePrimeNumber();
      const avg = averageUpTo(e, view, maxP);
      const cur = e[view]["p"+maxP];

      const status = e.eliminatedAt != null
        ? (() => {
            const labels = getLabelList();
            const idx = Number(e.eliminatedAt);
            const lbl = labels[idx] || ("Stage " + idx);
            return `Eliminated at ${lbl}`;
          })()
        : "Still in the competition";

      dom.infoExtra.textContent =
        `Current ${view.toUpperCase()}: ${(cur==null ? "—" : cur)} · Average: ${(avg==null ? "—" : (view==="score" ? avg.toFixed(1) : avg.toFixed(2)))} · ${status}`;

      updateElimEditor(e);
      renderChart(e);
    }

    function updateElimEditor(e){
      if(IS_VIEWER){
        dom.elimEditor.style.display = "none";
        return;
      }
      if(!appState.isEditMode){
        dom.elimEditor.style.display = "none";
        return;
      }
      dom.elimEditor.style.display = "block";

      dom.elimCheckbox.checked = (e.eliminatedAt != null);

      dom.elimPrime.innerHTML = `<option value="">Stage ?</option>` + getLabelList().map((lbl,i) =>
        `<option value="${i}">${lbl}</option>`
      ).join("");

      dom.elimPrime.value = (e.eliminatedAt != null ? String(e.eliminatedAt) : "");

      dom.elimCheckbox.onchange = () => {
        if(dom.elimCheckbox.checked){
          const p = getActivePrimeNumber();
          e.eliminatedAt = p;
          dom.elimPrime.value = String(p);
        }else{
          e.eliminatedAt = null;
          dom.elimPrime.value = "";
        }
        saveData();
        renderAll();
      };

      dom.elimPrime.onchange = () => {
        const v = dom.elimPrime.value;
        e.eliminatedAt = (v === "" ? null : Number(v));
        dom.elimCheckbox.checked = (e.eliminatedAt != null);
        saveData();
        renderAll();
      };
    }

    function renderChart(e){
      const ctx = document.getElementById("chartLine").getContext("2d");
      const view = appState.view;
      const lbls = getLabelList();

      const data = e ? lbls.map((_,i) => {
        const v = e[view]["p"+i];
        return (v==null ? null : Number(v));
      }) : [];

      if(chart){ chart.destroy(); chart = null; }

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: lbls,
          datasets: [{
            label: view.toUpperCase(),
            data,
            spanGaps: true,
            borderWidth: 2,
            pointRadius: 3,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              reverse: (view !== "score"),
              ticks: { color: getComputedStyle(document.body).getPropertyValue("--muted") },
              grid: { color: "rgba(148,163,184,.15)" }
            },
            x: {
              ticks: { color: getComputedStyle(document.body).getPropertyValue("--muted") },
              grid: { display:false }
            }
          },
          plugins: {
            legend: { display:false },
            tooltip: { enabled:true }
          }
        }
      });
    }

    /*********************************
     * 8. UI events
     *********************************/
    function fillPromoSelect(){
      const seasons = Array.from(new Set(eleves.map(e => e.promo))).sort();
      dom.promo.innerHTML = `<option value="all">All seasons</option>` + seasons.map(s => `<option value="${s}">${s}</option>`).join("");
      const p = new URLSearchParams(location.search).get("promo");
      if(p && seasons.includes(p)) dom.promo.value = p;
      else dom.promo.value = "all";
    }

   function initTabs(){
  if(!dom.viewSelect){
    console.warn("viewSelect not found");
    return;
  }

  // Synchronise le select avec l'état actuel (URL ou défaut)
  dom.viewSelect.value = appState.view;

  dom.viewSelect.addEventListener("change", () => {
    const v = dom.viewSelect.value;
    if(!VIEW_KEYS.includes(v)) return;

    appState.view = v;
    writeParamsToURL();
    renderAll(false);
  });
}


    function initEditMode() {
      if (IS_VIEWER) {
        appState.isEditMode = false;
        if (dom.modeToggle) dom.modeToggle.style.display = "none";
        return;
      }
      try {
        const saved = localStorage.getItem("kcaEditMode");
        appState.isEditMode = (saved === "1");
      } catch (e) {
        appState.isEditMode = false;
      }
      updateModeUI();
    }

    function updateModeUI(){
      dom.modeToggle.textContent = appState.isEditMode ? "VIEW MODE" : "EDIT MODE";
      updateElimEditor(eleves.find(x => x.id === appState.selectedId));
    }

    dom.modeToggle.addEventListener("click", () => {
          if (IS_VIEWER) return;
          appState.isEditMode = !appState.isEditMode;
      try{ localStorage.setItem("kcaEditMode", appState.isEditMode ? "1" : "0"); }catch(e){}
      updateModeUI();
      renderAll(false);
    });

    dom.sortBtn.addEventListener("click", () => {
      appState.sortByName = !appState.sortByName;
      dom.sortBtn.textContent = appState.sortByName ? "SORT: NAME" : "SORT BY NAME";
      renderAll();
    });

    dom.toggleElimBtn.addEventListener("click", () => {
      appState.hideElim = !appState.hideElim;
      dom.toggleElimBtn.textContent = appState.hideElim ? "SHOW ELIMINATED" : "HIDE ELIMINATED";
      writeParamsToURL();
      renderAll();
    });

    dom.q.addEventListener("input", () => { renderAll(false); });

    dom.promo.addEventListener("change", () => {
      writeParamsToURL();
      renderAll();
    });

    dom.prime.addEventListener("change", () => {
      writeParamsToURL();
      renderAll();
    });

    dom.share.addEventListener("click", async () => {
      const u = new URL(location.href);
      u.searchParams.set("viewer","1");
      const url = u.toString();
      try{
        await navigator.clipboard.writeText(url);
        alert("Link copied!");
      }catch(err){
        prompt("Copy this link:", url);
      }
    });

    dom.themeToggle.addEventListener("click", () => {
      const cur = document.body.getAttribute("data-theme") || "dark";
      const nxt = (cur === "dark") ? "light" : "dark";
      document.body.setAttribute("data-theme", nxt);
      dom.themeToggle.textContent = (nxt === "dark") ? "LIGHT MODE" : "DARK MODE";
      renderAll(false);
    });

    function initMenu(){
      if(!dom.menuBtn || !dom.menuPanel) return;

      function closeMenu(){
        dom.menuPanel.classList.remove("open");
        dom.menuBtn.setAttribute("aria-expanded","false");
      }
      function toggleMenu(){
        const open = dom.menuPanel.classList.toggle("open");
        dom.menuBtn.setAttribute("aria-expanded", open ? "true" : "false");
      }

      dom.menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleMenu();
      });

      document.addEventListener("click", () => closeMenu());
      window.addEventListener("resize", () => closeMenu());

      dom.menuPanel.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", () => closeMenu());
      });
    }

    /*********************************
     * 9. Render all
     *********************************/
    function renderAll(resetFocus=true){
      renderTable();
      renderProfile();
      // (Optional) keep URL in sync
      writeParamsToURL();
    }

    /*********************************
     * 10. Boot
     *********************************/
    function boot(){
      readParams();
      fillPromoSelect();
      loadSavedData();

      initTabs();
      initEditMode();
      initMenu();

      if(IS_VIEWER){
        appState.isEditMode = false;
        if(dom.modeToggle) dom.modeToggle.style.display = "none";
        if(dom.elimEditor) dom.elimEditor.style.display = "none";
      }

      // Default button labels
      dom.toggleElimBtn.textContent = appState.hideElim ? "SHOW ELIMINATED" : "HIDE ELIMINATED";

      // Chart library (CDN)
      if(!window.Chart){
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
        s.onload = () => renderAll();
        document.head.appendChild(s);
      }else{
        renderAll();
      }
    }

    boot();
  </script>
</body>
</html>
