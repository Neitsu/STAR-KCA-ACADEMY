<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Star KCA Academy</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0a0d15;
      --panel: #121a2b;
      --panel2: #1a2440;
      --text: #eef3ff;
      --muted: #9aa6c2;
      --line: #2d3d60;
      --accent: #8b5cf6;
      --accent2: #ec4899;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #1f2d4e 0%, #0d1425 45%, #070a12 100%);
    }
    .container { width: min(1160px, 92vw); margin: 0 auto; }
    header {
      position: sticky; top: 0; z-index: 30;
      backdrop-filter: blur(8px);
      background: rgba(10, 13, 21, .9);
      border-bottom: 1px solid var(--line);
    }
    .topbar { min-height: 68px; display: flex; align-items: center; justify-content: space-between; gap: .7rem; flex-wrap: wrap; padding: .8rem 0; }
    .brand h1 { margin: 0; font-size: 1.02rem; text-transform: uppercase; letter-spacing: .08em; }
    .brand p { margin: .2rem 0 0; color: var(--muted); font-size: .8rem; }
    nav { display: flex; gap: .5rem; flex-wrap: wrap; }
    .nav-link {
      text-decoration: none; color: var(--text); background: var(--panel);
      border: 1px solid var(--line); border-radius: 999px; padding: .42rem .74rem; font-size: .84rem;
    }
    .nav-link.active { background: linear-gradient(120deg, var(--accent), var(--accent2)); border-color: transparent; }
    main { padding: 1rem 0 2.6rem; }
    .page { display: none; }
    .page.active { display: block; }
    .card {
      background: linear-gradient(180deg, #19243d 0%, #111827 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    h2, h3 { margin: .2rem 0 .85rem; }
    .small { color: var(--muted); font-size: .82rem; }
    .filters { display: flex; flex-wrap: wrap; gap: .55rem; margin-bottom: .85rem; }
    input, select {
      border-radius: 10px; border: 1px solid var(--line);
      background: #0d1527; color: var(--text); padding: .52rem .7rem;
    }
    .contestants-grid { display: grid; gap: .8rem; grid-template-columns: repeat(auto-fill, minmax(178px, 1fr)); }
    .contestant-card {
      border: 1px solid var(--line); border-radius: 12px; overflow: hidden; cursor: pointer; background: #0d1526;
      transition: transform .12s ease;
    }
    .contestant-card:hover { transform: translateY(-2px); }
    .contestant-card img { width: 100%; height: 165px; object-fit: cover; display: block; }
    .contestant-card .body { padding: .68rem; }
    .contestant-card.star-card {
      border: 1px solid rgba(255, 203, 107, .7);
      background: radial-gradient(circle at 15% 10%, rgba(255,186,73,.20), transparent 34%), linear-gradient(180deg, #27140f 0%, #120f16 100%);
      box-shadow: 0 0 0 1px rgba(255, 210, 120, .18) inset, 0 10px 30px rgba(0,0,0,.35);
    }
    .star-media {
      height: 178px;
      display: grid;
      place-items: center;
      background: radial-gradient(circle at 60% 40%, rgba(255,160,70,.35), rgba(80,22,4,.2) 45%, rgba(10,13,21,.2) 80%);
      overflow: hidden;
      position: relative;
    }
    .star-media::before {
      content: "";
      position: absolute;
      width: 82%;
      aspect-ratio: 1;
      background: linear-gradient(160deg, rgba(255,233,159,.35), rgba(255,157,0,.2));
      clip-path: polygon(50% 0%, 61% 36%, 98% 36%, 68% 57%, 79% 92%, 50% 70%, 21% 92%, 32% 57%, 2% 36%, 39% 36%);
      filter: drop-shadow(0 0 8px rgba(255,200,70,.45));
    }
    .star-media img {
      width: 74%;
      height: 74%;
      object-fit: cover;
      clip-path: polygon(50% 2%, 60% 36%, 95% 36%, 67% 56%, 77% 90%, 50% 69%, 23% 90%, 33% 56%, 5% 36%, 40% 36%);
      border: 1px solid rgba(255, 221, 154, .9);
      position: relative;
      z-index: 1;
    }
    .pill { display: inline-block; margin-top: .32rem; padding: .16rem .52rem; border-radius: 999px; font-size: .72rem; border: 1px solid transparent; }
    .safe { background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.45); }
    .nominee { background: rgba(245,158,11,.16); border-color: rgba(245,158,11,.42); }
    .saved_judges, .saved_public { background: rgba(59,130,246,.16); border-color: rgba(59,130,246,.42); }
    .eliminated { background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.42); }
    .tbd { background: rgba(148,163,184,.16); border-color: rgba(148,163,184,.42); }
    .row { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 840px) { .row.two { grid-template-columns: 280px 1fr; } }
    .profile-img { width: 100%; max-width: 260px; border-radius: 12px; border: 1px solid var(--line); }
    .btn { text-decoration: none; color: var(--text); border: 1px solid var(--line); background: var(--panel2); border-radius: 10px; padding: .42rem .7rem; display: inline-block; }
    .table-wrap { overflow: auto; }
    table { width: 100%; border-collapse: collapse; font-size: .88rem; }
    th, td { border-bottom: 1px solid var(--line); padding: .5rem .36rem; text-align: left; white-space: nowrap; }
    .chip { display: inline-block; border: 1px solid var(--line); border-radius: 999px; padding: .18rem .52rem; font-size: .74rem; background: rgba(99,102,241,.12); }
    .vote-row { margin-bottom: .72rem; }
    .bar { width: 100%; height: 12px; border: 1px solid var(--line); background: #091224; border-radius: 999px; overflow: hidden; }
    .bar > span { display: block; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  </style>
</head>
<body>
<header>
  <div class="container topbar">
    <div class="brand">
      <h1>Star KCA Academy</h1>
      <p>Contestants · Rankings · Votes</p>
    </div>
    <nav id="nav"></nav>
  </div>
</header>

<main class="container">
  <section id="contestants" class="page active"></section>
  <section id="profile" class="page"></section>
  <section id="rankings" class="page"></section>
  <section id="votes" class="page"></section>
</main>

<script>
const CONFIG = {
  SHEET_ID: "1wllhbdbdIJM3uTI-WnJFE5eJ8zb_scgik5k94Yegc1s",
  SHEETS: {
    contestants: "contestants",
    rounds: "rounds",
    submissions: "submissions",
    scores: "scores",
    judge_rankings: "judge_rankings",
    round_status: "round_status",
    votes_live: "votes_live"
  },
  REFRESH_MS: 30000,
  ROUND_TABS: {
    PRERANK: "PRERANK",
    ROUND_1: "R1",
    ROUND_2: "R2",
    ROUND_3: "R3",
    ROUND_4: "R4",
    ROUND_5: "R5",
    ROUND_6: "R6",
    FINAL: "FINAL"
  },
  VOTE_FORM_URL: "https://docs.google.com/forms/d/e/1FAIpQLSdRAvtdk_e2yVjhhLJmvh6UJhMd4tw6OIzBHkbyLaau7tt8cQ/viewform?usp=header"
};

const ROUND_ORDER = ["PRERANK", "ROUND_1", "ROUND_2", "ROUND_3", "ROUND_4", "ROUND_5", "ROUND_6", "FINAL"];
const ROUND_LABELS = { PRERANK: "Prerank", ROUND_1: "R1", ROUND_2: "R2", ROUND_3: "R3", ROUND_4: "R4", ROUND_5: "R5", ROUND_6: "R6", FINAL: "Final" };
const CANDIDATE_NAMES = ["yza","hope","lea","megara","asli","chanel","heaven","manuee","hwa_young","mimi","eria","panida","kelsy","suhaa","johi","sun","kora","brahmini","katie","donghyun","lizy","kyo"];
const PRETTY = { yza:"Yza", hope:"Hope", lea:"Lea", megara:"Megara", asli:"Asli", chanel:"Chanel", heaven:"Heaven", manuee:"Manuee", hwa_young:"Hwa Young", mimi:"Mimi", eria:"Eria", panida:"Panida", kelsy:"Kelsy", suhaa:"Suhaa", johi:"Johi", sun:"Sun", kora:"Kora", brahmini:"Brahmini", katie:"Katie", donghyun:"Donghyun", lizy:"Lizy", kyo:"Kyo" };

const JUDGE_NAMES = ["Neitsu", "Bibiblu", "Kaina", "Hauras", "Cal", "Aya"];

const PRERANK_MANUAL_ROWS = [
  { name: 'Asli', instagram: '@aslcvrs', official_rank: 5, score: 89 },
  { name: 'Brahmini', instagram: '@brahmini.vc', official_rank: 18, score: 71 },
  { name: 'Chanel', instagram: '@chgnelx_cover', official_rank: 6, score: 86.5 },
  { name: 'Donghyun', instagram: '@dongnhyu', official_rank: 20, score: 67.5 },
  { name: 'Eria', instagram: '@oyesoowa', official_rank: 11, score: 82.5 },
  { name: 'Heaven', instagram: '@heavens.venture', official_rank: 7, score: 86 },
  { name: 'Hope', instagram: '@ihopeexoo', official_rank: 2, score: 94 },
  { name: 'Hwa Young', instagram: '@hwa_young.kca', official_rank: 9, score: 86 },
  { name: 'Johi', instagram: '@hgn_johi', official_rank: 15, score: 76.5 },
  { name: 'Katie', instagram: '@katiesmelodies', official_rank: 19, score: 71 },
  { name: 'Kelsy', instagram: '@kelsyuniverse', official_rank: 13, score: 80.5 },
  { name: 'Kora', instagram: '@kora_chu0_o', official_rank: 17, score: 75 },
  { name: 'Kyo', instagram: '@kykycovgh', official_rank: 22, score: 60.5 },
  { name: 'Lea', instagram: '@jwleakca', official_rank: 3, score: 91.5 },
  { name: 'Lizy', instagram: '@lizy.off', official_rank: 21, score: 62.5 },
  { name: 'Manuee', instagram: '@_kcamanu', official_rank: 8, score: 86 },
  { name: 'Megara', instagram: '@_megnfique', official_rank: 4, score: 90 },
  { name: 'Mimi', instagram: 'Iwannabemimimi', official_rank: 10, score: 85.5 },
  { name: 'Panida', instagram: '@1stPanidaW', official_rank: 12, score: 82 },
  { name: 'Suhaa', instagram: '@_soobieb00bie_', official_rank: 14, score: 78.5 },
  { name: 'Sun', instagram: '@sun._.kca', official_rank: 16, score: 76.5 },
  { name: 'Yza', instagram: '@yzavliss', official_rank: 1, score: 97.5 }
];

const R1_MANUAL_ROWS = [
  { name: 'Asli', instagram: '@aslcvrs', performance: 'GABRIELA', link: 'https://www.instagram.com/reel/DUp7RDxDMeP/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Brahmini', instagram: '@brahmini.vc', performance: 'SHEESH', link: 'https://www.instagram.com/reel/DUqCB2MjOau/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Chanel', instagram: '@chanelx_cover', performance: 'SUPERSCAR', link: 'https://www.instagram.com/reel/DUqCUs0DHSE/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Donghyun', instagram: '@dongnhyu', performance: 'FAMOUS', link: 'https://www.instagram.com/reel/DUnyzUHjMTz/?igsh=NHF4N21wc29pZm5o' },
  { name: 'Eria', instagram: '@oyesoowa', performance: 'GREEDY', link: 'https://www.instagram.com/reel/DUqVKrcjNH9/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Heaven', instagram: '@heavens.venture', performance: 'ABRACADABRA', link: 'https://www.instagram.com/reel/DUqCHvDjP_E/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Hope', instagram: 'ihopeexo', performance: 'MIDNIGHT SUN', link: 'https://www.instagram.com/reel/DUnzEkfDEv9/?igsh=MTA5ajlpcDQ3a3YzdQ==' },
  { name: 'Hwa Young', instagram: '@hwa_young.kca', performance: 'GABRIELA', link: '' },
  { name: 'Johi', instagram: '@han_johi', performance: 'SHEESH', link: 'https://www.instagram.com/reel/DUqBvFkDDK8/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Katie', instagram: '@katiesmelodies', performance: 'GREEDY', link: 'https://www.instagram.com/reel/DUqBeD_DKXj/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Kelsy', instagram: '@kelsyuniverse', performance: 'GABRIELA', link: 'https://www.instagram.com/reel/DUp7AYdDBbv/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Kora', instagram: '@kora_chu0_o', performance: 'GABRIELA', link: 'https://www.instagram.com/reel/DUp7LKHDN14/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Kyo', instagram: '@kykycovgh', performance: 'SODA POP', link: 'https://www.instagram.com/reel/DUqVftqDK8C/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Lea', instagram: '@jwleakca', performance: 'SUPERSCAR', link: 'https://www.instagram.com/reel/DUk5QK2DC8K/?igsh=aTMyZHRkcGt6NGRv' },
  { name: 'Lizy', instagram: '@lizy.off', performance: 'GREEDY', link: 'https://www.instagram.com/reel/DUqB1jsjA7A/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Manuee', instagram: '@_kcamanu', performance: 'ABRACADABRA', link: 'https://www.instagram.com/reel/DUk44gyDCbp/?igsh=MTQ4anBxajU3ZXUzdw==' },
  { name: 'Megara', instagram: '@_megnifique', performance: 'UNETHICAL', link: 'https://www.instagram.com/reel/DUqBk_XjJmk/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Mimi', instagram: 'Iwannabemimimi', performance: 'SUPERSCAR', link: 'https://www.instagram.com/reel/DUk4g-9DHa5/?igsh=OTJkdm9qa3g1c3B3' },
  { name: 'Panida', instagram: '@1stPanidaW', performance: 'WHERE IS MY HUSBAND', link: 'https://www.instagram.com/reel/DUp79mfDM5e/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==' },
  { name: 'Suhaa', instagram: '@_soobieboobie_', performance: 'FAMOUS', link: 'https://www.instagram.com/reel/DUnzQByjHZk/?igsh=MWs4cWJqZWt2ZWN6' },
  { name: 'Sun', instagram: '@sun._.kca', performance: 'MIDNIGHT SUN', link: 'https://www.instagram.com/reel/DUnylisjLqH/?igsh=MWhodXg0cjlyeWpvNg==' },
  { name: 'Yza', instagram: '@yzavliss', performance: 'UNETHICAL', link: '' }
];


function canonicalRoundId(value) {
  const raw = String(value || '').trim().toUpperCase().replace(/\s+/g, '_').replace(/-/g, '_');
  if (!raw) return '';
  if (raw in ROUND_LABELS) return raw;
  const m = raw.match(/^ROUND_?(\d+)$/);
  if (m) return `ROUND_${m[1]}`;
  if (raw === 'PRE_RANK' || raw === 'PRERANKING') return 'PRERANK';
  if (raw === 'FINALS') return 'FINAL';
  if (/^R[1-6]$/.test(raw)) return `ROUND_${raw.slice(1)}`;
  if (raw === 'RF' || raw === 'RFINAL') return 'FINAL';
  return raw;
}


function normalizedToken(value) {
  return String(value || '').toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g, '').replace(/[^a-z0-9]/g, '');
}

function resolveContestantIdByName(name) {
  const aliases = {
    chgnel: 'chanel',
    chanel: 'chanel',
    hwayoung: 'hwa_young',
    manuee: 'manuee',
    sunda: 'suhaa'
  };
  const token = normalizedToken(name);
  if (!token) return '';
  if (aliases[token]) return aliases[token];

  const fromLoaded = state.data.contestants.find(c => normalizedToken(c.name) == token);
  if (fromLoaded) return fromLoaded.id;

  for (const id of CANDIDATE_NAMES) {
    if (normalizedToken(PRETTY[id]) === token || normalizedToken(id) === token.replace(/_/g,'')) return id;
  }
  return toSlug(name);
}

function applyManualPrerankSeed() {
  const hasOfficialPrerank = state.data.judge_rankings.some(r => r.round_id === 'PRERANK' && normalizeJudgeName(r.judge_name) === 'official');
  const hasScorePrerank = state.data.scores.some(s => s.round_id === 'PRERANK' && Number.isFinite(Number(s.total)));

  PRERANK_MANUAL_ROWS.forEach((row) => {
    const id = resolveContestantIdByName(row.name);
    if (!id) return;

    let contestant = state.data.contestants.find(c => c.id === id);
    if (!contestant) {
      contestant = { id, name: row.name, photo_url: `assets/${id}.jpg`, country: 'TBD', bio: 'Bio TBD', instagram: '', pronouns: '' };
      state.data.contestants.push(contestant);
    }
    if (!contestant.instagram && row.instagram) contestant.instagram = row.instagram;

    if (!hasOfficialPrerank) {
      state.data.judge_rankings.push({ round_id: 'PRERANK', judge_name: 'official', contestant_id: id, rank: row.official_rank });
    }
    if (!hasScorePrerank) {
      state.data.scores.push({ round_id: 'PRERANK', contestant_id: id, total: row.score });
    }
  });
}

function applyManualR1Seed() {
  const hasR1Submissions = state.data.submissions.some(s => s.round_id === 'ROUND_1' && (String(s.song_title || '').trim() || String(s.youtube_url || '').trim() || String(s.bandlab_url || '').trim()));

  R1_MANUAL_ROWS.forEach((row) => {
    const id = resolveContestantIdByName(row.name);
    if (!id) return;

    let contestant = state.data.contestants.find(c => c.id === id);
    if (!contestant) {
      contestant = { id, name: row.name, photo_url: `assets/${id}.jpg`, country: 'TBD', bio: 'Bio TBD', instagram: '', pronouns: '' };
      state.data.contestants.push(contestant);
    }
    if (!contestant.instagram && row.instagram) contestant.instagram = row.instagram;

    if (!hasR1Submissions && (row.performance || row.link)) {
      state.data.submissions.push({
        round_id: 'ROUND_1',
        contestant_id: id,
        song_title: row.performance || '',
        group_song: '',
        bandlab_url: '',
        youtube_url: row.link || '',
        notes: ''
      });
    }
  });
}

function enforcePrerankSafeStatus() {
  const contestantIds = state.data.contestants.length
    ? state.data.contestants.map(c => c.id).filter(Boolean)
    : [...CANDIDATE_NAMES];

  state.data.round_status = state.data.round_status.filter(r => r.round_id !== "PRERANK");
  contestantIds.forEach((contestantId) => {
    state.data.round_status.push({ round_id: "PRERANK", contestant_id: contestantId, status: "safe" });
  });
}

function normalizeHeaderKey(key) {
  return String(key || '').toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g, '').replace(/[^a-z0-9]/g, '');
}

function toSlug(value) {
  return String(value || '').toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g, '').replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
}

function pickValue(row, aliases) {
  const keyMap = {};
  Object.keys(row || {}).forEach(k => { keyMap[normalizeHeaderKey(k)] = row[k]; });
  for (const alias of aliases) {
    const v = keyMap[normalizeHeaderKey(alias)];
    if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();
  }
  return '';
}

function toFiniteNumber(value) {
  if (value === null || value === undefined || value === '') return null;
  const n = Number(String(value).replace(',', '.'));
  return Number.isFinite(n) ? n : null;
}

async function fetchOptionalSheetTab(sheetName) {
  try { return await fetchSheetTab(sheetName); } catch { return []; }
}

async function loadDataFromRoundTabs() {
  const contestantsMap = new Map();
  const submissions = [];
  const scores = [];
  const judge_rankings = [];

  for (const roundId of ROUND_ORDER) {
    const tabName = CONFIG.ROUND_TABS?.[roundId] || ROUND_LABELS[roundId];
    let rows = [];
    try {
      rows = await fetchSheetTab(tabName);
    } catch {
      continue;
    }

    rows.forEach((row) => {
      const name = pickValue(row, ['name', 'candidate', 'contestant', 'nom', 'candidat']);
      if (!name) return;
      const contestantId = toSlug(pickValue(row, ['id', 'contestant_id']) || name);
      const instagram = pickValue(row, ['instagram', 'instagram_handle', 'username', 'ig', 'insta']);
      const performance = pickValue(row, ['performance', 'song', 'prestation']);
      const performanceLink = pickValue(row, ['performance_link', 'link', 'url', 'youtube_url', 'youtube', 'bandlab_url']);
      const officialRank = toFiniteNumber(pickValue(row, ['official_rank', 'officialrank', 'rank_official', 'official', 'rank']));
      const perfScore = toFiniteNumber(pickValue(row, ['performance_score', 'performancescore', 'creator_score', 'score', 'total']));

      if (!contestantsMap.has(contestantId)) {
        contestantsMap.set(contestantId, {
          id: contestantId,
          name,
          photo_url: `assets/${contestantId}.jpg`,
          country: 'TBD',
          bio: 'Bio TBD',
          instagram: instagram || '',
          pronouns: ''
        });
      } else if (instagram && !contestantsMap.get(contestantId).instagram) {
        contestantsMap.get(contestantId).instagram = instagram;
      }

      if (Number.isFinite(officialRank)) {
        judge_rankings.push({ round_id: roundId, judge_name: 'official', contestant_id: contestantId, rank: officialRank });
      }

      const judges = [
        ['Neitsu', ['neitsu']],
        ['Bibiblu', ['bibiblu']],
        ['Kaina', ['kaina']],
        ['Hauras', ['hauras']],
        ['Cal', ['cal']],
        ['Aya', ['aya']]
      ];
      judges.forEach(([judge, aliases]) => {
        const r = toFiniteNumber(pickValue(row, aliases));
        if (Number.isFinite(r)) judge_rankings.push({ round_id: roundId, judge_name: judge, contestant_id: contestantId, rank: r });
      });

      if (Number.isFinite(perfScore)) {
        scores.push({ round_id: roundId, contestant_id: contestantId, total: perfScore });
      }

      if (performance || performanceLink) {
        submissions.push({
          round_id: roundId,
          contestant_id: contestantId,
          song_title: performance || '',
          group_song: '',
          bandlab_url: '',
          youtube_url: performanceLink || '',
          notes: ''
        });
      }
    });
  }

  const contestants = [...contestantsMap.values()];
  return {
    contestants,
    rounds: ROUND_ORDER.map(r => ({ round_id: r, round_name: ROUND_LABELS[r], start_date: '', end_date: '' })),
    submissions,
    scores,
    judge_rankings,
    round_status: await fetchOptionalSheetTab(CONFIG.SHEETS.round_status),
    votes_live: await fetchOptionalSheetTab(CONFIG.SHEETS.votes_live)
  };
}

const state = {
  data: { contestants: [], rounds: [], submissions: [], scores: [], judge_rankings: [], round_status: [], votes_live: [] },
  latestRound: "PRERANK",
  profileChart: null,
  rankingsChart: null,
  votesRound: "PRERANK",
  votesTimer: null,
  rankingView: "official"
};

async function fetchSheetTab(sheetName) {
  if (!CONFIG.SHEET_ID || CONFIG.SHEET_ID.includes("PASTE")) throw new Error("No sheet id configured");
  const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const res = await fetch(url);
  const text = await res.text();
  const payload = JSON.parse(text.substring(47, text.length - 2));
  const cols = payload.table.cols.map(c => c.label);
  return payload.table.rows.map(r => {
    const obj = {};
    cols.forEach((col, i) => obj[col] = r.c[i]?.v ?? "");
    return obj;
  });
}

function fallbackData() {
  return {
    contestants: CANDIDATE_NAMES.map((id) => ({
      id,
      name: PRETTY[id],
      photo_url: `assets/${id}.jpg`,
      country: "TBD",
      bio: "Bio to be filled.",
      instagram: "",
      pronouns: ""
    })),
    rounds: ROUND_ORDER.map(r => ({ round_id: r, round_name: ROUND_LABELS[r], start_date: "", end_date: "" })),
    submissions: [],
    scores: [],
    judge_rankings: [],
    round_status: [],
    votes_live: []
  };
}

async function loadData() {
  try {
    const entries = await Promise.all(Object.entries(CONFIG.SHEETS).map(async ([k, v]) => [k, await fetchSheetTab(v)]));
    state.data = Object.fromEntries(entries);
    if (!Array.isArray(state.data.contestants) || state.data.contestants.length === 0) {
      state.data = await loadDataFromRoundTabs();
    }
  } catch {
    try {
      state.data = await loadDataFromRoundTabs();
      if (!state.data.contestants?.length) state.data = fallbackData();
    } catch {
      state.data = fallbackData();
    }
  }
}


function normalizeData() {
  state.data.round_status = Array.isArray(state.data.round_status) ? state.data.round_status : [];
  state.data.scores = Array.isArray(state.data.scores) ? state.data.scores : [];
  state.data.judge_rankings = Array.isArray(state.data.judge_rankings) ? state.data.judge_rankings : [];
  state.data.submissions = Array.isArray(state.data.submissions) ? state.data.submissions : [];
  state.data.votes_live = Array.isArray(state.data.votes_live) ? state.data.votes_live : [];

  const normId = (v) => String(v || '').trim().toLowerCase().replace(/\s+/g, '_');

  state.data.round_status = state.data.round_status.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id) }));
  state.data.scores = state.data.scores.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id) }));
  state.data.judge_rankings = state.data.judge_rankings.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id) }));
  state.data.submissions = state.data.submissions.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id) }));
  state.data.votes_live = state.data.votes_live.map(r => ({ ...r, round_id: canonicalRoundId(r.round_id), contestant_id: normId(r.contestant_id) }));
  const raw = Array.isArray(state.data.contestants) ? state.data.contestants : [];
  const byId = new Map();
  raw.forEach((c) => {
    const id = String(c.id || '').trim().toLowerCase().replace(/\s+/g, '_');
    if (!id) return;
    byId.set(id, {
      id,
      name: c.name || PRETTY[id] || id,
      photo_url: c.photo_url || `assets/${id}.jpg`,
      country: c.country || 'TBD',
      bio: c.bio || 'Bio TBD',
      instagram: c.instagram || '',
      pronouns: c.pronouns || ''
    });
  });
  if (!byId.size) {
    CANDIDATE_NAMES.forEach((id) => byId.set(id, {
      id,
      name: PRETTY[id] || id,
      photo_url: `assets/${id}.jpg`,
      country: 'TBD',
      bio: 'Bio TBD',
      instagram: '',
      pronouns: ''
    }));
  }
  state.data.contestants = [...byId.values()];
}


function setupNav() {
  const tabs = ["contestants", "rankings", "votes"];
  document.getElementById("nav").innerHTML = tabs.map(t => `<a class="nav-link" href="#${t}">${t[0].toUpperCase() + t.slice(1)}</a>`).join("");
}

function setPage(hash) {
  const target = hash.startsWith("#profile/") ? "profile" : (hash.replace("#", "") || "contestants");
  document.querySelectorAll(".page").forEach(p => p.classList.toggle("active", p.id === target));
  document.querySelectorAll(".nav-link").forEach(a => a.classList.toggle("active", a.getAttribute("href") === `#${target}`));
  if (target === "profile") renderProfile(hash.split("/")[1]);
}

function getContestantName(id) {
  return state.data.contestants.find(c => c.id === id)?.name || PRETTY[id] || id;
}

function getOfficialRankingByRound() {
  const result = {};
  ROUND_ORDER.forEach(r => result[r] = {});

  const officialRows = state.data.judge_rankings.filter(r => String(r.judge_name || "").toLowerCase() === "official");
  if (officialRows.length) {
    ROUND_ORDER.forEach(round => {
      const rows = officialRows.filter(r => r.round_id === round).map(r => ({ id: r.contestant_id, rank: Number(r.rank) })).filter(r => Number.isFinite(r.rank));
      rows.forEach(row => result[round][row.id] = row.rank);
    });
    return result;
  }

  ROUND_ORDER.forEach(round => {
    const rows = state.data.scores
      .filter(s => s.round_id === round)
      .map(s => ({ id: s.contestant_id, total: Number(s.total) }))
      .filter(s => Number.isFinite(s.total))
      .sort((a, b) => b.total - a.total);
    rows.forEach((row, idx) => result[round][row.id] = idx + 1);
  });

  return result;
}


function normalizeJudgeName(value) {
  return String(value || '').trim().toLowerCase();
}

function getJudgeRankingByRound(judgeName) {
  const result = {};
  ROUND_ORDER.forEach(r => result[r] = {});
  const target = normalizeJudgeName(judgeName);
  const rows = state.data.judge_rankings.filter(r => normalizeJudgeName(r.judge_name) === target);
  ROUND_ORDER.forEach(round => {
    rows
      .filter(r => r.round_id === round)
      .map(r => ({ id: r.contestant_id, rank: Number(r.rank) }))
      .filter(r => Number.isFinite(r.rank))
      .forEach(r => { result[round][r.id] = r.rank; });
  });
  return result;
}

function getPerformanceScoreByRound() {
  const result = {};
  ROUND_ORDER.forEach(r => result[r] = {});
  ROUND_ORDER.forEach(round => {
    state.data.scores
      .filter(s => s.round_id === round)
      .forEach(s => {
        const total = Number(s.total);
        if (Number.isFinite(total)) result[round][s.contestant_id] = total;
      });
  });
  return result;
}

function getPerformanceRankingByRound() {
  const byScore = getPerformanceScoreByRound();
  const result = {};
  ROUND_ORDER.forEach(r => result[r] = {});
  ROUND_ORDER.forEach(round => {
    Object.entries(byScore[round])
      .map(([id, score]) => ({ id, score }))
      .sort((a, b) => b.score - a.score)
      .forEach((row, idx) => { result[round][row.id] = idx + 1; });
  });
  return result;
}

function getRankingMapByView(view) {
  if (view === 'official') return getOfficialRankingByRound();
  if (view === 'performance_score') return getPerformanceScoreByRound();
  return getJudgeRankingByRound(view.replace('judge:', ''));
}

function getRankingViewOptions() {
  const options = [{ value: 'official', label: 'Official ranking' }];
  JUDGE_NAMES.forEach(name => options.push({ value: `judge:${name}`, label: `Judge · ${name}` }));
  options.push({ value: 'performance_score', label: 'Performance score' });
  return options;
}

function getLatestRound(officialByRound) {
  for (let i = ROUND_ORDER.length - 1; i >= 0; i--) {
    const round = ROUND_ORDER[i];
    const hasRanking = Object.keys(officialByRound[round] || {}).length > 0;
    const hasStatus = state.data.round_status.some(r => r.round_id === round);
    if (hasRanking || hasStatus) return round;
  }
  return "PRERANK";
}

function getStatus(roundId, contestantId) {
  return state.data.round_status.find(r => r.round_id === roundId && r.contestant_id === contestantId)?.status || "";
}

function statusLabel(status) {
  return status ? status.replace("_", " ") : "TBD";
}

function statusClass(status) {
  return status || "tbd";
}

function sortedContestants() {
  const officialByRound = getOfficialRankingByRound();
  const currentRanks = officialByRound[state.latestRound] || {};
  return [...state.data.contestants].sort((a, b) => {
    const aStatus = getStatus(state.latestRound, a.id);
    const bStatus = getStatus(state.latestRound, b.id);
    const aElim = aStatus === "eliminated" ? 1 : 0;
    const bElim = bStatus === "eliminated" ? 1 : 0;
    if (aElim !== bElim) return aElim - bElim;

    const ar = currentRanks[a.id];
    const br = currentRanks[b.id];
    if (Number.isFinite(ar) && Number.isFinite(br)) return ar - br;
    if (Number.isFinite(ar)) return -1;
    if (Number.isFinite(br)) return 1;
    return String(a.name || PRETTY[a.id] || a.id).localeCompare(String(b.name || PRETTY[b.id] || b.id));
  });
}

function renderContestants() {
  const root = document.getElementById("contestants");
  root.innerHTML = `
    <div class="card">
      <h2>Contestants</h2>
      <p class="small">Auto-updated from latest available official ranking/status round: <span class="chip">${ROUND_LABELS[state.latestRound]}</span></p>
      <div class="filters">
        <input id="searchContestant" placeholder="Search name..." />
        <select id="statusFilter">
          <option value="all">All status</option>
          <option value="safe">safe</option>
          <option value="nominee">nominee</option>
          <option value="saved_judges">saved judges</option>
          <option value="saved_public">saved public</option>
          <option value="eliminated">eliminated</option>
          <option value="tbd">TBD</option>
        </select>
        <select id="cardStyleFilter">
          <option value="classic">Card style: Classic</option>
          <option value="star">Card style: Star</option>
        </select>
      </div>
      <p class="small">✨ Test idea inspired by Star Academy logo: switch to <strong>Star</strong> card style.</p>
      <div id="contestantsGrid" class="contestants-grid"></div>
    </div>`;

  const draw = () => {
    const q = document.getElementById("searchContestant").value.toLowerCase().trim();
    const f = document.getElementById("statusFilter").value;
    const list = sortedContestants().filter(c => c.name.toLowerCase().includes(q)).filter(c => {
      const status = getStatus(state.latestRound, c.id);
      if (f === "all") return true;
      if (f === "tbd") return !status;
      return status === f;
    });

    const cardStyle = document.getElementById("cardStyleFilter").value;
    document.getElementById("contestantsGrid").innerHTML = list.map(c => {
      const status = getStatus(state.latestRound, c.id);
      const media = cardStyle === "star"
        ? `<div class="star-media"><img src="${c.photo_url}" alt="${c.name}" onerror="this.src='https://placehold.co/400x300?text=${c.name}'" /></div>`
        : `<img src="${c.photo_url}" alt="${c.name}" onerror="this.src='https://placehold.co/400x300?text=${c.name}'" />`;
      return `<article class="contestant-card ${cardStyle === "star" ? "star-card" : ""}" onclick="location.hash='#profile/${c.id}'">
        ${media}
        <div class="body"><strong>${c.name}</strong><div class="small">${c.country || "TBD"}</div><span class="pill ${statusClass(status)}">${statusLabel(status)}</span></div>
      </article>`;
    }).join("") || `<p class="small">No contestants found.</p>`;
  };

  document.getElementById("searchContestant").addEventListener("input", draw);
  document.getElementById("statusFilter").addEventListener("change", draw);
  document.getElementById("cardStyleFilter").addEventListener("change", draw);
  draw();
}

function renderRankings() {
  const rankingMap = getRankingMapByView(state.rankingView);
  const root = document.getElementById("rankings");
  const viewOptions = getRankingViewOptions();
  const isPerformanceMode = state.rankingView === 'performance_score';

  const contestants = [...state.data.contestants].sort((a, b) => {
    const av = rankingMap[state.latestRound][a.id];
    const bv = rankingMap[state.latestRound][b.id];
    const aNum = Number.isFinite(av);
    const bNum = Number.isFinite(bv);
    if (aNum && bNum) return isPerformanceMode ? (bv - av) : (av - bv);
    if (aNum) return -1;
    if (bNum) return 1;
    return String(a.name || '').localeCompare(String(b.name || ''));
  });

  const rowsForNominations = {
    nominee: state.data.round_status.filter(r => r.round_id === state.latestRound && r.status === "nominee"),
    saved_judges: state.data.round_status.filter(r => r.round_id === state.latestRound && r.status === "saved_judges"),
    saved_public: state.data.round_status.filter(r => r.round_id === state.latestRound && r.status === "saved_public"),
    eliminated: state.data.round_status.filter(r => r.round_id === state.latestRound && r.status === "eliminated")
  };
  const nameList = (arr) => arr.map(r => getContestantName(r.contestant_id)).join(", ") || "TBD";
  const firstColLabel = isPerformanceMode ? 'Points' : 'Rank';

  root.innerHTML = `
    <div class="card">
      <h2>Rankings · Trajectory</h2>
      <div class="filters">
        <select id="rankingViewSelect">${viewOptions.map(opt => `<option value="${opt.value}" ${opt.value===state.rankingView?"selected":""}>${opt.label}</option>`).join("")}</select>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>${firstColLabel}</th>
              <th>Name</th>
              ${ROUND_ORDER.map(r => `<th><span class="chip">${ROUND_LABELS[r]}</span></th>`).join("")}
            </tr>
          </thead>
          <tbody>
            ${contestants.map((c, idx) => {
              const currentVal = rankingMap[state.latestRound][c.id];
              const displayCurrent = Number.isFinite(currentVal)
                ? (isPerformanceMode ? (Math.round(currentVal * 10) / 10) : currentVal)
                : "—";
              return `<tr>
                <td>${displayCurrent}</td>
                <td>${c.name}</td>
                ${ROUND_ORDER.map(r => {
                  const val = rankingMap[r][c.id];
                  if (!Number.isFinite(val)) return `<td>—</td>`;
                  return `<td>${isPerformanceMode ? (Math.round(val * 10) / 10) : val}</td>`;
                }).join("")}
              </tr>`;
            }).join("")}
          </tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <h3>Nominations (${ROUND_LABELS[state.latestRound]})</h3>
      <p><strong>Nominated:</strong> ${nameList(rowsForNominations.nominee)}</p>
      <p><strong>Saved by judges:</strong> ${nameList(rowsForNominations.saved_judges)}</p>
      <p><strong>Saved by public:</strong> ${nameList(rowsForNominations.saved_public)}</p>
      <p><strong>Eliminated:</strong> ${nameList(rowsForNominations.eliminated)}</p>
    </div>
    <div class="card">
      <h3>Global trajectory chart</h3>
      <p class="small">${isPerformanceMode ? 'All contestants are shown. Higher score is better.' : 'All contestants are shown. Lower rank is better (1 = top).'}</p>
      <canvas id="allContestantsChart" height="120"></canvas>
    </div>`;

  document.getElementById('rankingViewSelect').addEventListener('change', (e) => {
    state.rankingView = e.target.value;
    renderRankings();
  });

  const datasets = contestants.map((c, idx) => ({
    label: c.name,
    data: ROUND_ORDER.map(r => rankingMap[r][c.id] ?? null),
    borderColor: `hsl(${(idx * 33) % 360} 82% 66%)`,
    backgroundColor: "transparent",
    borderWidth: 1.8,
    pointRadius: 1.8,
    tension: .2,
    spanGaps: true
  }));

  const allValues = datasets.flatMap(d => d.data).filter(v => Number.isFinite(v));
  const maxY = allValues.length ? Math.max(...allValues) : (isPerformanceMode ? 100 : Math.max(22, state.data.contestants.length));

  if (state.rankingsChart) state.rankingsChart.destroy();
  state.rankingsChart = new Chart(document.getElementById("allContestantsChart"), {
    type: "line",
    data: { labels: ROUND_ORDER.map(r => ROUND_LABELS[r]), datasets },
    options: {
      plugins: { legend: { labels: { color: "#eef3ff", boxWidth: 10, font: { size: 10 } } } },
      scales: {
        x: { ticks: { color: "#9aa6c2" } },
        y: isPerformanceMode
          ? { min: 0, max: Math.ceil(maxY + 5), ticks: { color: "#9aa6c2" } }
          : { reverse: true, min: 1, max: Math.max(22, state.data.contestants.length), ticks: { color: "#9aa6c2", stepSize: 1 } }
      }
    }
  });
}

function renderProfile(contestantId) {
  const c = state.data.contestants.find(x => x.id === contestantId) || state.data.contestants[0];
  if (!c) return;

  const officialByRound = getOfficialRankingByRound();
  const scores = state.data.scores.filter(s => s.contestant_id === c.id);
  const submissions = state.data.submissions.filter(s => s.contestant_id === c.id);

  document.getElementById("profile").innerHTML = `
    <div class="card"><a class="btn" href="#contestants">← Back to contestants</a></div>
    <div class="card row two">
      <img class="profile-img" src="${c.photo_url}" alt="${c.name}" onerror="this.src='https://placehold.co/400x420?text=${c.name}'" />
      <div>
        <h2>${c.name}</h2>
        ${c.bio ? `<p>${c.bio}</p>` : ""}
        <p class="small">${[c.country && c.country!=="TBD" ? `Country: ${c.country}` : "", c.pronouns ? `Pronouns: ${c.pronouns}` : "", c.instagram ? `Instagram: ${c.instagram}` : ""].filter(Boolean).join(" · ")}</p>
      </div>
    </div>
    <div class="card">
      <h3>Rounds overview</h3>
      <div class="table-wrap"><table>
      <thead><tr><th>Round</th><th>Official</th><th>Neitsu</th><th>Bibiblu</th><th>Kaina</th><th>Hauras</th><th>Cal</th><th>Aya</th><th>Performance score</th><th>Performance rank</th><th>Status</th></tr></thead>
      <tbody>
      ${(() => {
        const perfScoreByRound = getPerformanceScoreByRound();
        const perfRankByRound = getPerformanceRankingByRound();
        const judges = {
          neitsu: getJudgeRankingByRound('Neitsu'),
          bibiblu: getJudgeRankingByRound('Bibiblu'),
          kaina: getJudgeRankingByRound('Kaina'),
          hauras: getJudgeRankingByRound('Hauras'),
          cal: getJudgeRankingByRound('Cal'),
          aya: getJudgeRankingByRound('Aya')
        };
        return ROUND_ORDER.map(r => {
          const rank = officialByRound[r][c.id];
          const status = getStatus(r, c.id);
          const perfScore = perfScoreByRound[r][c.id];
          const perfRank = perfRankByRound[r][c.id];
          return `<tr><td>${ROUND_LABELS[r]}</td><td>${Number.isFinite(rank) ? rank : "—"}</td><td>${judges.neitsu[r][c.id] ?? "—"}</td><td>${judges.bibiblu[r][c.id] ?? "—"}</td><td>${judges.kaina[r][c.id] ?? "—"}</td><td>${judges.hauras[r][c.id] ?? "—"}</td><td>${judges.cal[r][c.id] ?? "—"}</td><td>${judges.aya[r][c.id] ?? "—"}</td><td>${Number.isFinite(perfScore) ? perfScore : "—"}</td><td>${Number.isFinite(perfRank) ? perfRank : "—"}</td><td>${statusLabel(status)}</td></tr>`;
        }).join("");
      })()}
      </tbody>
      </table></div>
    </div>
    <div class="card">
      <h3>Performances</h3>
      <div class="table-wrap"><table>
      <thead><tr><th>Round</th><th>Song</th><th>Links</th></tr></thead>
      <tbody>
      ${submissions.map(s => `<tr><td>${ROUND_LABELS[s.round_id] || s.round_id}</td><td>${s.song_title || s.group_song || "TBD"}</td><td>${s.youtube_url ? `<a target="_blank" href="${s.youtube_url}">Link to the Performance</a>` : "—"}${s.bandlab_url ? ` · <a target="_blank" href="${s.bandlab_url}">BandLab</a>` : ""}</td></tr>`).join("") || `<tr><td colspan="3">No performance links yet.</td></tr>`}
      </tbody>
      </table></div>
    </div>
    <div class="card"><h3>Individual trajectory chart</h3><canvas id="profileChart" height="110"></canvas></div>`;

  if (state.profileChart) state.profileChart.destroy();
  state.profileChart = new Chart(document.getElementById("profileChart"), {
    type: "line",
    data: {
      labels: ROUND_ORDER.map(r => ROUND_LABELS[r]),
      datasets: [{
        label: `${c.name} official rank`,
        data: ROUND_ORDER.map(r => officialByRound[r][c.id] ?? null),
        borderColor: "#8b5cf6",
        backgroundColor: "rgba(139,92,246,.2)",
        tension: .25,
        spanGaps: true
      }]
    },
    options: {
      plugins: { legend: { labels: { color: "#eef3ff" } } },
      scales: {
        x: { ticks: { color: "#9aa6c2" } },
        y: { reverse: true, min: 1, max: Math.max(22, state.data.contestants.length), ticks: { color: "#9aa6c2", stepSize: 1 } }
      }
    }
  });
}

function renderVotes() {
  const root = document.getElementById("votes");
  const roundsWithVotes = ROUND_ORDER.filter(r => state.data.votes_live.some(v => v.round_id === r));
  const canonicalSelected = canonicalRoundId(state.votesRound);
  state.votesRound = ROUND_ORDER.includes(canonicalSelected) ? canonicalSelected : (roundsWithVotes[0] || state.latestRound);

  const nominees = state.data.round_status.filter(r => r.round_id === state.votesRound && r.status === "nominee").map(r => r.contestant_id);
  const targets = nominees.length ? nominees : [...new Set(state.data.votes_live.filter(v => v.round_id === state.votesRound).map(v => v.contestant_id))];
  const rows = targets.map(id => {
    const record = state.data.votes_live.find(v => v.round_id === state.votesRound && v.contestant_id === id);
    return { id, name: getContestantName(id), votes: Number(record?.votes_count || 0), updated: record?.last_updated || "-" };
  }).sort((a, b) => b.votes - a.votes);
  const totalVotes = rows.reduce((sum, r) => sum + r.votes, 0);

  root.innerHTML = `
    <div class="card">
      <h2>Votes</h2>
      <div class="filters">
        <select id="votesRoundSelect">${ROUND_ORDER.map(r => `<option value="${r}" ${r===state.votesRound?"selected":""}>${ROUND_LABELS[r]}</option>`).join("")}</select>
        ${CONFIG.VOTE_FORM_URL ? `<a class="btn" target="_blank" rel="noopener noreferrer" href="${CONFIG.VOTE_FORM_URL}">Vote now</a>` : ""}
      </div>
      ${CONFIG.VOTE_FORM_URL ? `<p class="small">Use the vote form to submit your save vote for this round.</p>` : ""}
      ${rows.length ? rows.map(r => {
        const pct = totalVotes > 0 ? (r.votes / totalVotes) * 100 : 0;
        return `<div class="vote-row"><div><strong>${r.name}</strong> — ${r.votes} votes (${pct.toFixed(1)}%)</div><div class="bar"><span style="width:${pct}%"></span></div></div>`;
      }).join("") : `<p>No vote data for this round yet.</p>${roundsWithVotes.length ? `<p class="small">Available vote rounds: ${roundsWithVotes.map(r => ROUND_LABELS[r]).join(', ')}</p>` : ''}`}
      <p class="small">Total votes: ${totalVotes} · Last refresh: ${new Date().toLocaleString("fr-FR")}</p>
    </div>`;

  document.getElementById("votesRoundSelect").addEventListener("change", (e) => {
    state.votesRound = e.target.value;
    renderVotes();
  });

  clearTimeout(state.votesTimer);
  state.votesTimer = setTimeout(async () => {
    await loadData();
    normalizeData();
    applyManualPrerankSeed();
    applyManualR1Seed();
    enforcePrerankSafeStatus();
    const officialByRound = getOfficialRankingByRound();
    state.latestRound = getLatestRound(officialByRound);
    renderContestants();
    renderRankings();
    renderVotes();
  }, CONFIG.REFRESH_MS);
}

async function boot() {
  setupNav();
  await loadData();
  normalizeData();
  applyManualPrerankSeed();
  applyManualR1Seed();
  enforcePrerankSafeStatus();
  const officialByRound = getOfficialRankingByRound();
  state.latestRound = getLatestRound(officialByRound);
  const roundsWithVotes = ROUND_ORDER.filter(r => state.data.votes_live.some(v => v.round_id === r));
  state.votesRound = roundsWithVotes[0] || state.latestRound;

  renderContestants();
  renderRankings();
  renderVotes();

  setPage(location.hash || "#contestants");
  window.addEventListener("hashchange", () => setPage(location.hash));
}

boot();
</script>
</body>
</html>
