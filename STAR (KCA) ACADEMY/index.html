<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>STAR (KCA) ACADEMY — Rankings Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box}
    :root{
      --bg:#070b12;
      --bg-soft:#111827;
      --bg-softer:#0b1220;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#4f46e5;
      --accent-soft:rgba(79,70,229,.12);
      --accent-strong:#a855f7;
      --danger:#ef4444;
      --gold:#facc15;
      --up:#22c55e;
      --down:#f97316;
      --card-radius:20px;
      --shadow-soft:0 18px 40px rgba(15,23,42,.7)
    }

    /* Thème clair */
    body[data-theme="light"]{
      --bg:#f3f4f6;
      --bg-soft:#ffffff;
      --bg-softer:#e5e7eb;
      --border:#d1d5db;
      --text:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-soft:rgba(37,99,235,.1);
      --accent-strong:#7c3aed;
      --danger:#b91c1c;
      --gold:#ca8a04;
      --up:#16a34a;
      --down:#ea580c;
      background:radial-gradient(circle at top,#e5e7eb 0,#f9fafb 55%,#e5e7eb 100%);
      color:var(--text);
    }
    body[data-theme="light"] .card{
      background:linear-gradient(180deg,#ffffff,#f3f4f6);
      border-color:var(--border);
      box-shadow:0 12px 25px rgba(148,163,184,.4);
    }
    body[data-theme="light"] .table-wrapper{
      background:#ffffff;
      border-color:var(--border);
    }
    body[data-theme="light"] thead{
      background:linear-gradient(90deg,#e5e7eb,#f3f4f6);
    }
    body[data-theme="light"] tbody tr,
    body[data-theme="light"] tbody tr:nth-child(2n){
      background:#ffffff;
    }
    body[data-theme="light"] tbody tr:hover{
      background:#e5e7eb;
    }
    body[data-theme="light"] tbody tr.selected{
      background:linear-gradient(90deg,#e0f2fe,#ede9fe);
    }
    body[data-theme="light"] .chart-wrap{
      background:linear-gradient(180deg,#ffffff,#e5e7eb);
      border-color:var(--border);
    }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:radial-gradient(circle at top,#1d2537 0,#020617 55%,#000 100%);
      color:var(--text);
      min-height:100vh;
      -webkit-font-smoothing:antialiased
    }
    main{padding:24px 16px 40px}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    .logo{
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:.9rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:10px
    }
    .logo span{
      display:inline-flex;
      padding:4px 10px;
      border-radius:999px;
      background:linear-gradient(120deg,#a855f7,#4f46e5);
      color:#0f172a;
      font-size:.75rem;
      box-shadow:0 12px 30px rgba(88,28,135,.7)
    }
    h1{
      margin:.4rem 0 0;
      font-size:1.9rem;
      letter-spacing:.04em;
      text-transform:uppercase
    }
    .subtitle{
      margin-top:.4rem;
      font-size:.9rem;
      color:var(--muted)
    }
    .subtitle strong{color:var(--gold)}
    .grid{
      display:grid;
      grid-template-columns:2.4fr 1.8fr;
      gap:24px;
      margin-top:24px
    }
    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:radial-gradient(circle at top left,#1f2937 0,rgba(15,23,42,.9) 55%,#020617 100%);
      border-radius:var(--card-radius);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:var(--shadow-soft);
      padding:18px 18px 16px;
      position:relative;
      overflow:hidden
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.08),transparent 55%);
      opacity:.7;
      pointer-events:none
    }
    .card>div,.card>header{position:relative;z-index:1}
    .card header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:12px
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#e5e7eb
    }
    body[data-theme="light"] .card-title{color:#111827;}
    .card-subtitle{
      font-size:.8rem;
      color:var(--muted)
    }
    .pill{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.5);
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:#e5e7eb
    }
    body[data-theme="light"] .pill{
      background:#e5e7eb;
      color:#111827;
      border-color:#cbd5f5;
    }
    .pill span.dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#22c55e 0,#16a34a 40%,#0f766e 100%);
      box-shadow:0 0 10px rgba(34,197,94,.7)
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:8px
    }
    .toolbar-left{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .toolbar-right{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
    .field{
      position:relative;
      display:flex;
      align-items:center;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
      padding:0 10px;
      min-height:32px;
      font-size:.8rem;
      color:var(--muted);
      gap:6px
    }
    body[data-theme="light"] .field{
      background:#f9fafb;
      border-color:#d1d5db;
      color:#6b7280;
    }
    .field input,.field select{
      background:transparent;
      border:none;
      outline:none;
      color:inherit;
      font:inherit
    }
    .field input::placeholder{color:#6b7280}
    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      padding:6px 12px;
      font-size:.75rem;
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:.12em;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,transform .1s ease
    }
    .btn-ghost{background:transparent;border-color:rgba(51,65,85,.9);color:var(--muted)}
    .btn-primary{
      background:linear-gradient(135deg,#4f46e5,#7c3aed);
      border-color:rgba(129,140,248,.9);
      color:#e5e7eb;
      box-shadow:0 10px 25px rgba(55,48,163,.7)
    }
    .btn:hover{transform:translateY(-1px);border-color:#e5e7eb}
    .btn-primary:hover{background:linear-gradient(135deg,#6366f1,#a855f7)}
    body[data-theme="light"] .btn-ghost{
      border-color:#d1d5db;
      color:#4b5563;
    }
    body[data-theme="light"] .btn-primary{
      background:linear-gradient(135deg,#2563eb,#7c3aed);
      color:#f9fafb;
    }
    .seg{
      display:inline-flex;
      background:rgba(15,23,42,.9);
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      padding:2px
    }
    .seg button{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:4px 9px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      min-width:0
    }
    .seg button.active{
      background:rgba(79,70,229,.15);
      color:#e5e7eb
    }
    body[data-theme="light"] .seg{
      background:#f3f4f6;
      border-color:#d1d5db;
    }
    body[data-theme="light"] .seg button.active{
      background:#e5e7eb;
      color:#111827;
    }

    .table-wrapper{
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,.95);
      background:radial-gradient(circle at top,#020617 0,#020617 50%,#000 100%);
      overflow-x:auto;
      overflow-y:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
      min-width:1800px;
    }
    thead{
      background:linear-gradient(90deg,rgba(15,23,42,.98),rgba(17,24,39,.98));
      position:relative
    }
    thead::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 0 0,rgba(129,140,248,.18),transparent 55%);
      opacity:.7;
      pointer-events:none
    }
    thead th{
      text-align:left;
      font-weight:500;
      padding:8px 10px;
      border-bottom:1px solid rgba(55,65,81,.95);
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:.68rem;
      white-space:nowrap
    }
    thead th.num{
      text-align:center;
    }

    /* Colonnes figées (# + Candidat) */
    th.sticky-rank{
      position:sticky;
      left:0;
      z-index:5;
      background:inherit;
    }
    th.sticky-col{
      position:sticky;
      left:50px;
      z-index:4;
      background:inherit;
      width:230px;
      max-width:230px;
    }

    tbody tr{
      border-bottom:1px solid rgba(31,41,55,.85);
      background:linear-gradient(90deg,rgba(15,23,42,.92),rgba(15,23,42,.9));
      cursor:pointer;
      transition:background .12s ease,transform .06s ease
    }
    tbody tr:nth-child(2n){background:linear-gradient(90deg,rgba(15,23,42,.92),rgba(15,23,42,.94))}
    tbody tr:hover{background:rgba(30,64,175,.35)}
    tbody tr.selected{
      background:radial-gradient(circle at 0 0,rgba(129,140,248,.45),rgba(30,64,175,.85));
      transform:translateY(-1px)
    }
    tbody tr.row-elim{opacity:0.8;}
    tbody td{
      padding:7px 10px;
      vertical-align:middle
    }
    td.rank{
      width:50px;
      font-weight:600;
      color:var(--muted);
      font-variant-numeric:tabular-nums;
      text-align:center;
    }
    td.rank.sticky-rank{
      position:sticky;
      left:0;
      z-index:3;
      background:inherit;
    }
    td.num{
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    td.name{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:500;
      position:relative;
      z-index:3;
      white-space:nowrap;
      min-width:0;
    }
    td.name .name-wrap{
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
      flex:1;
    }
    td.name .name-text{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }
    td.name.sticky-col{
      position:sticky;
      left:50px;
      background:inherit;
      box-shadow:8px 0 12px rgba(15,23,42,.9);
      width:230px;
      max-width:230px;
    }
    body[data-theme="light"] td.name.sticky-col{
      box-shadow:8px 0 12px rgba(209,213,219,.9);
    }
    .avatar{
      width:26px;
      height:26px;
      border-radius:999px;
      object-fit:cover;
      border:1px solid rgba(148,163,184,.75);
      box-shadow:0 6px 16px rgba(15,23,42,.8)
    }
    .chip{
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted)
    }
    body[data-theme="light"] .chip{
      background:#f3f4f6;
      border-color:#d1d5db;
      color:#6b7280;
    }
    .chip.elim{
      border-color:rgba(248,113,113,.7);
      color:#fecaca;
      background:rgba(127,29,29,.7)
    }
    .delta{
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
      font-size:.75rem;
      color:var(--muted);
      margin-left:auto;
    }
    .delta.up{color:var(--up)}
    .delta.down{color:var(--down)}
    .mini{
      margin-top:14px;
      font-size:.75rem;
      color:var(--muted);
      line-height:1.4
    }
    .profile{
      display:flex;
      flex-direction:column;
      gap:12px
    }
    .profile-main{
      display:flex;
      gap:12px;
      align-items:center
    }
    .profile-pic-wrap{
      position:relative;
      width:88px;
      height:88px;
      border-radius:24px;
      padding:2px;
      background:conic-gradient(from 210deg,#4f46e5,#a855f7,#22c55e,#4f46e5);
      box-shadow:0 18px 45px rgba(15,23,42,.9)
    }
    .profile-pic-inner{
      position:relative;
      width:100%;
      height:100%;
      border-radius:inherit;
      overflow:hidden;
      background:radial-gradient(circle at top,#1f2937,#020617)
    }
    .profile-pic-inner img{
      width:100%;
      height:100%;
      object-fit:cover
    }
    .profile-text h2{
      margin:0;
      font-size:1.1rem;
      letter-spacing:.04em;
      text-transform:uppercase
    }
    .profile-text p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:.8rem
    }
    .badge-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px
    }
    .badge{
      font-size:.7rem;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      background:rgba(15,23,42,.9);
      color:var(--muted)
    }
    .badge.gold{
      border-color:rgba(250,204,21,.7);
      color:var(--gold);
      background:rgba(23,37,84,.9)
    }
    body[data-theme="light"] .badge{
      background:#f3f4f6;
      border-color:#d1d5db;
      color:#4b5563;
    }
    body[data-theme="light"] .badge.gold{
      background:#fef3c7;
      border-color:#fbbf24;
      color:#92400e;
    }
    .chart-wrap{
      margin-top:6px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,.9);
      background:radial-gradient(circle at top,#020617,#000);
      padding:10px;
      height:260px;
      position:relative
    }
    .chart-wrap::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 20% 0,rgba(59,130,246,.22),transparent 55%);
      opacity:.7;
      pointer-events:none
    }
    .chart-wrap>canvas{position:relative;z-index:1}
    .sr{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0
    }

    /* Inputs d'édition dans le tableau */
    .table-input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:inherit;
      font:inherit;
      text-align:center;
    }
    .table-input::placeholder{
      color:var(--muted);
      opacity:0.6;
    }
  </style>
</head>
<body data-theme="dark">
  <main>
    <header class="container">
      <div class="logo">
        <span>STAR (KCA) ACADEMY</span>
        Dashboard des rounds
      </div>
      <h1>STAR (KCA) ACADEMY — Rankings</h1>
         </header>

    <div class="container">
      <div class="grid">
        <!-- COLONNE GAUCHE : TABLEAU -->
        <div class="card">
          <header>
            <div>
              <div class="card-title">Top contestants</div>
              <div class="card-subtitle">Filter by stage, source, and season.</div>
            </div>
            <div class="pill">
              <span class="dot"></span>
              Live ranking
            </div>
          </header>

          <div class="toolbar">
            <div class="toolbar-left">
              <div class="field" style="min-width:190px">
                <input id="q" type="search" placeholder="Search a contestant…" />
              </div>

              <label class="sr" for="promo">Season</label>
              <select id="promo" aria-label="Filter by season"></select>

              <label class="sr" for="prime">Stage</label>
              <select id="prime" aria-label="Active stage">
                <option value="auto">Auto (latest stage)</option>
                <option value="0">PRERANK</option>
                <option value="1">ROUND 1</option>
                <option value="2">ROUND 2</option>
                <option value="3">ROUND 3</option>
                <option value="4">ROUND 4</option>
                <option value="5">ROUND 5</option>
                <option value="6">ROUND 6</option>
                <option value="7">FINAL</option>
              </select>

              <div class="seg" role="tablist" aria-label="Ranking source">
                <button type="button" data-view="rank" role="tab" aria-selected="true" class="active">
                  RANK
                </button>
                <button type="button" data-view="neitsu" role="tab" aria-selected="false">
                  NEITSU
                </button>
                <button type="button" data-view="hauras" role="tab" aria-selected="false">
                  HAURAS
                </button>
                <button type="button" data-view="bibi" role="tab" aria-selected="false">
                  BIBI BLU
                </button>
                <button type="button" data-view="kaina" role="tab" aria-selected="false">
                  KAINA
                </button>
                <button type="button" data-view="cal" role="tab" aria-selected="false">
                  CAL
                </button>
                <button type="button" data-view="aya" role="tab" aria-selected="false">
                  AYA
                </button>
                <button type="button" data-view="score" role="tab" aria-selected="false">
                  SCORE
                </button>
              </div>
            </div>

            <div class="toolbar-right">
              <button id="modeToggle" class="btn btn-ghost" type="button">
                Edit mode
              </button>
              <button id="sortBtn" class="btn btn-ghost" type="button">
                Sort by name
              </button>
              <button id="toggleElimBtn" class="btn btn-ghost" type="button">
                Hide eliminated
              </button>
              <button id="share" class="btn btn-primary" type="button">
                Copy link
              </button>
              <button id="themeToggle" class="btn btn-ghost" type="button">
                Light mode
              </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table id="top">
              <thead>
                <tr>
                  <th class="sticky-rank">#</th>
                  <th class="sticky-col">Contestant</th>
                  
                  <th class="num" data-prime="0">PRERANK</th>
                  <th class="num" data-prime="1">ROUND 1</th>
                  <th class="num" data-prime="2">ROUND 2</th>
                  <th class="num" data-prime="3">ROUND 3</th>
                  <th class="num" data-prime="4">ROUND 4</th>
                  <th class="num" data-prime="5">ROUND 5</th>
                  <th class="num" data-prime="6">ROUND 6</th>
                  <th class="num" data-prime="7">FINAL</th>
                  <th class="num">Average</th>
                </tr>
              </thead>
              <tbody id="topBody"></tbody>
            </table>
          </div>
        </div>

        <!-- COLONNE DROITE : PROFIL + GRAPHIQUE -->
        <div class="card">
          <header>
            <div>
              <div class="card-title">Contestant profile & chart</div>
              <div class="card-subtitle">Click a contestant to see their trajectory.</div>
            </div>
          </header>

          <div class="profile">
            <div class="profile-main">
              <div class="profile-pic-wrap">
                <div class="profile-pic-inner">
                  <img id="pic" src="assets/placeholder.jpg" alt="Selected contestant" />
                </div>
              </div>
              <div class="profile-text">
                <h2 id="infoName">Select a contestant</h2>
                <p id="infoPromo">Season —</p>
                <div class="badge-row">
                  <span class="badge gold">Active stage</span>
                  <span class="badge">RANK / NEITSU / HAURAS / BIBI BLU / KAINA / CAL / AYA / SCORE</span>
                </div>
                <p id="infoExtra" style="margin-top:6px;font-size:.8rem;color:var(--muted);max-width:260px;">
                  Rank, average, and elimination status will appear here.
                </p>
                <div id="elimEditor" style="margin-top:8px;font-size:.8rem;display:none;">
                  <label style="display:inline-flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="elimCheckbox" />
                    Eliminated
                  </label>
                  <select id="elimPrime" style="margin-left:6px;">
                    <option value="">Stage…</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="chart-wrap">
              <canvas id="chartLine"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="container">
      <p class="mini">
        Δ places = change in rank compared to the previous stage (▲ = up, ▼ = down).
        Click a contestant to highlight their line.
      </p>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
  (() => {
    "use strict";

    /*********************************
     * Stockage (localStorage + fallback)
     * - localStorage = persistant (recommandé)
     * - fallback window.name = persiste tant que l'onglet reste ouvert
     *********************************/
    const STORE_PREFIX = "KCA_STORE:";
    function storageAvailable() {
      try {
        const x = "__kca_test__";
        localStorage.setItem(x, x);
        localStorage.removeItem(x);
        return true;
      } catch (e) {
        return false;
      }
    }
    const STORAGE_OK = storageAvailable();

    function readStorage(key) {
      try {
        if (STORAGE_OK) return localStorage.getItem(key);
        if (!window.name || !window.name.startsWith(STORE_PREFIX)) return null;
        const bag = JSON.parse(window.name.slice(STORE_PREFIX.length)) || {};
        return (key in bag) ? String(bag[key]) : null;
      } catch (e) {
        return null;
      }
    }

    function writeStorage(key, value) {
      try {
        if (STORAGE_OK) {
          localStorage.setItem(key, value);
          return true;
        }
        let bag = {};
        if (window.name && window.name.startsWith(STORE_PREFIX)) {
          bag = JSON.parse(window.name.slice(STORE_PREFIX.length)) || {};
        }
        bag[key] = value;
        window.name = STORE_PREFIX + JSON.stringify(bag);
        return true;
      } catch (e) {
        return false;
      }
    }


    const MAX_PRIME = 7;
    const STAGE_LABELS = ['PRERANK', 'ROUND 1', 'ROUND 2', 'ROUND 3', 'ROUND 4', 'ROUND 5', 'ROUND 6', 'FINAL'];
    const PRIMES_KEYS = Array.from({ length: MAX_PRIME + 1 }, (_, i) => "p" + i);

    const VIEW_DEFS = [
      { key:"rank",   label:"RANK",    kind:"rank" },
      { key:"neitsu", label:"NEITSU",  kind:"rank" },
      { key:"hauras", label:"HAURAS",  kind:"rank" },
      { key:"bibi",   label:"BIBI BLU",kind:"rank" },
      { key:"kaina",  label:"KAINA",   kind:"rank" },
      { key:"cal",    label:"CAL",     kind:"rank" },
      { key:"aya",    label:"AYA",     kind:"rank" },
      { key:"score",  label:"SCORE",   kind:"score" }
    ];
    const VIEW_KEYS = VIEW_DEFS.map(v=>v.key);

        /*********************************
     * 1. Candidats (promo)
     *********************************/
        const baseEleves = [
      { id:1, nom: "Yza", promo: "KCA 2026", img: "assets/yza.jpg", eliminatedAt: null },
      { id:2, nom: "Hope", promo: "KCA 2026", img: "assets/hope.jpg", eliminatedAt: null },
      { id:3, nom: "Lea", promo: "KCA 2026", img: "assets/lea.jpg", eliminatedAt: null },
      { id:4, nom: "Megara", promo: "KCA 2026", img: "assets/megara.jpg", eliminatedAt: null },
      { id:5, nom: "Asli", promo: "KCA 2026", img: "assets/asli.jpg", eliminatedAt: null },
      { id:6, nom: "Chanel", promo: "KCA 2026", img: "assets/chanel.jpg", eliminatedAt: null },
      { id:7, nom: "Heaven", promo: "KCA 2026", img: "assets/heaven.jpg", eliminatedAt: null },
      { id:8, nom: "Manuee", promo: "KCA 2026", img: "assets/manuee.jpg", eliminatedAt: null },
      { id:9, nom: "Hwa Young", promo: "KCA 2026", img: "assets/hwa_young.jpg", eliminatedAt: null },
      { id:10, nom: "Mimi", promo: "KCA 2026", img: "assets/mimi.jpg", eliminatedAt: null },
      { id:11, nom: "Eria", promo: "KCA 2026", img: "assets/eria.jpg", eliminatedAt: null },
      { id:12, nom: "Panida", promo: "KCA 2026", img: "assets/panida.jpg", eliminatedAt: null },
      { id:13, nom: "Kelsy", promo: "KCA 2026", img: "assets/kelsy.jpg", eliminatedAt: null },
      { id:14, nom: "Suhaa", promo: "KCA 2026", img: "assets/suhaa.jpg", eliminatedAt: null },
      { id:15, nom: "Johi", promo: "KCA 2026", img: "assets/johi.jpg", eliminatedAt: null },
      { id:16, nom: "Sun", promo: "KCA 2026", img: "assets/sun.jpg", eliminatedAt: null },
      { id:17, nom: "Kora", promo: "KCA 2026", img: "assets/kora.jpg", eliminatedAt: null },
      { id:18, nom: "Brahmini", promo: "KCA 2026", img: "assets/brahmini.jpg", eliminatedAt: null },
      { id:19, nom: "Katie", promo: "KCA 2026", img: "assets/katie.jpg", eliminatedAt: null },
      { id:20, nom: "Donghyun", promo: "KCA 2026", img: "assets/donghyun.jpg", eliminatedAt: null },
      { id:21, nom: "Lizy", promo: "KCA 2026", img: "assets/lizy.jpg", eliminatedAt: null },
      { id:22, nom: "Kyo", promo: "KCA 2026", img: "assets/kyo.jpg", eliminatedAt: null },
    ];

    const eleves = baseEleves.map(e => {
      const obj = { ...e };
      // 8 sources : 7 classements (1=meilleur) + 1 score (/100)
      VIEW_KEYS.forEach(k => { obj[k] = {}; });

      for (let p = 0; p <= MAX_PRIME; p++) {
        const key = "p" + p;
        VIEW_KEYS.forEach(k => { obj[k][key] = null; });
      }

      return obj;
    });

    /*********************************
     * Helpers
     *********************************/
    const fmt = (n) => {
      if (n == null) return "—";
      const v = Number(n);
      return Number.isInteger(v) ? v.toString() : v.toFixed(1);
    };
    const uniq = (arr) => [...new Set(arr)];
    const mean = (arr) => {
      const vals = arr.filter(v => v != null).map(Number);
      if (!vals.length) return null;
      return vals.reduce((a,b)=>a+b,0)/vals.length;
    };
    const getLabelList = () => STAGE_LABELS.slice();

    function maxAvailablePrime() {
      let max = 0;
      eleves.forEach(e => {
        for (let p = 0; p <= MAX_PRIME; p++) {
          const key = "p" + p;
          let hasAny = false;
          for (const k of VIEW_KEYS) {
            if (e[k] && e[k][key] != null) { hasAny = true; break; }
          }
          if (hasAny && p > max) max = p;
        }
      });
      return max;
    }

    function primeToNum(str) {
      if (str === "auto" || !str) return maxAvailablePrime();
      const n = parseInt(str, 10);
      if (Number.isNaN(n) || n < 0) return 0;
      if (n > MAX_PRIME) return MAX_PRIME;
      return n;
    }

    /*********************************
     * URL params
     *********************************/
    function readParamsFromURL() {
      const p = new URLSearchParams(location.search);
      const hasHideElim = p.has("hideElim");
      const hideElimRaw = p.get("hideElim");
      return {
        view:     p.get("view")  || "rank",
        q:        p.get("q")     || "",
        promo:    p.get("promo") || "all",
        prime:    p.get("prime") || "auto",
        sort:     p.get("sort")  || "rank",
        // null = non précisé dans l'URL (on pourra prendre le localStorage)
        hideElim: hasHideElim ? (hideElimRaw === "1" || hideElimRaw === "true") : null
      };
    }
    function writeParamsToURL(state) {
      const p = new URLSearchParams();
      if (typeof VIEW_ONLY !== "undefined" && VIEW_ONLY) p.set("viewer","1");
      if (state.view  && state.view  !== "rank") p.set("view",  state.view);
      if (state.q)                                     p.set("q",     state.q);
      if (state.promo && state.promo !== "all")       p.set("promo", state.promo);
      if (state.prime && state.prime !== "auto")      p.set("prime", state.prime);
      if (state.sort  && state.sort  !== "rank")      p.set("sort",  state.sort);
      if (state.hideElim)                              p.set("hideElim", "1");
      const qs = p.toString();
      const url = location.pathname + (qs ? ("?" + qs) : "");
      history.replaceState(null,"",url);
    }

    /*********************************
     * Calculs
     *********************************/
    function sourceForView(eleve, view) {
      return eleve[view] || {};
    }

    function averageUpTo(src, upto) {
      const vals = [];
      for (let p = 0; p <= upto; p++) {
        vals.push(src["p" + p]);
      }
      return mean(vals);
    }

    function isScoreView(view){ return view === "score"; }

    function lastKnownValue(row) {
      for (let p = MAX_PRIME; p >= 0; p--) {
        const key = "p" + p;
        const v = row[key];
        if (v != null) return Number(v);
      }
      return null;
    }

    function compareRows(a,b,view){
      const aNull = (a.moy == null);
      const bNull = (b.moy == null);
      if (aNull && bNull) return 0;
      if (aNull) return 1;
      if (bNull) return -1;

      // SCORE: plus haut = meilleur (tri décroissant)
      if (isScoreView(view)) {
        if (a.moy !== b.moy) return b.moy - a.moy;
        const al = lastKnownValue(a);
        const bl = lastKnownValue(b);
        if (al != null && bl != null && al !== bl) return bl - al;
      } else {
        // Classements: plus bas = meilleur (tri croissant)
        if (a.moy !== b.moy) return a.moy - b.moy;
        const al = lastKnownValue(a);
        const bl = lastKnownValue(b);
        if (al != null && bl != null && al !== bl) return al - bl;
      }

      return a.nom.localeCompare(b.nom);
    }

    function computeRows(list, view, primeNum) {
      return list
        .map(eleve => {
          const src = sourceForView(eleve, view);
          const row = { ...eleve };
          PRIMES_KEYS.forEach(key => {
            row[key] = (src[key] == null ? null : Number(src[key]));
          });
          row.moy = averageUpTo(src, primeNum);
          return row;
        })
        .sort((a,b) => compareRows(a,b,view))
        .map((row,i) => ({ ...row, rank: i+1 }));
    }

    function compute(list, primeNum, view) {
      const pNow = primeNum;
      const pPrev = (pNow > 0) ? pNow - 1 : null;

      const rowsNow = computeRows(list, view, pNow);

      const rankPrevMap = new Map();
      if (pPrev != null) {
        const rowsPrev = computeRows(list, view, pPrev);
        rowsPrev.forEach(r => rankPrevMap.set(r.id, r.rank));
      }

      return rowsNow.map(r => {
        const prevRank    = rankPrevMap.get(r.id);
        const deltaPlaces = (prevRank != null) ? (prevRank - r.rank) : 0;
        return {
          ...r,
          eliminated: (r.eliminatedAt != null && pNow >= r.eliminatedAt),
          deltaPlaces
        };
      });
    }

    /*********************************
     * LocalStorage (scores + éliminations + modes)
     *********************************/
    function loadSavedData() {
      try {
        const raw = readStorage("kcaDataV1");
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.eleves)) return;
        parsed.eleves.forEach(saved => {
          const target = eleves.find(e => e.id === saved.id);
          if (!target) return;

          if ("eliminatedAt" in saved) {
            target.eliminatedAt = (saved.eliminatedAt == null ? null : Math.max(0, Math.min(Number(saved.eliminatedAt), MAX_PRIME)));
          }

          // Restaure toutes les sources
          VIEW_KEYS.forEach(k => {
            if (saved[k]) Object.assign(target[k], saved[k]);
          });
        });
      } catch (e) {
        console.warn("Storage read error", e);
      }
    }

    function saveData() {
      const payload = {
        version: 1,
        eleves: eleves.map(e => {
          const obj = {
            id: e.id,
            eliminatedAt: e.eliminatedAt ?? null
          };
          VIEW_KEYS.forEach(k => { obj[k] = e[k]; });
          return obj;
        })
      };
      const ok = writeStorage("kcaDataV1", JSON.stringify(payload));
      if (!ok) console.warn("Impossible d'écrire dans le stockage (localStorage bloqué ?)");
    }

    /*********************************
     * DOM & rendu
     *********************************/
    const dom = {
      inputSearch: document.getElementById("q"),
      promoSelect: document.getElementById("promo"),
      primeSelect: document.getElementById("prime"),
      sortBtn:     document.getElementById("sortBtn"),
      toggleElimBtn:document.getElementById("toggleElimBtn"),
      shareBtn:    document.getElementById("share"),
      themeToggle: document.getElementById("themeToggle"),
      modeToggle:  document.getElementById("modeToggle"),
      tabs:        Array.from(document.querySelectorAll(".seg [role='tab']")),
      tbody:       document.getElementById("topBody"),
      pic:         document.getElementById("pic"),
      infoName:    document.getElementById("infoName"),
      infoPromo:   document.getElementById("infoPromo"),
      infoExtra:   document.getElementById("infoExtra"),
      chartCanvas: document.getElementById("chartLine"),
      elimEditor:  document.getElementById("elimEditor"),
      elimCheckbox:document.getElementById("elimCheckbox"),
      elimPrime:   document.getElementById("elimPrime")
    };

    const urlState = readParamsFromURL();
    const VIEW_ONLY = (new URLSearchParams(location.search).get("viewer") === "1");
    const hideElimFromURL = (urlState.hideElim != null);

    const appState = {
      ...urlState,
      hideElim: (urlState.hideElim == null ? false : !!urlState.hideElim),
      nameAsc: false,
      isEditMode: false
    };

    let chartLine = null;
    let selectedId = null;
    appState.nameAsc = (appState.sort === "name");

    /********* Thème jour / nuit *********/
    function applyTheme(theme){
      document.body.dataset.theme = theme;
      if (dom.themeToggle){
        dom.themeToggle.textContent = theme === "dark" ? "Light mode" : "Dark mode";
      }
      try{
        writeStorage("kcaTheme", theme);
      }catch(e){}
    }
    function initTheme(){
      let saved = null;
      try{
        saved = readStorage("kcaTheme");
      }catch(e){}
      const theme = saved === "light" || saved === "dark" ? saved : "dark";
      applyTheme(theme);
    }

    /********* Afficher / masquer les éliminé·e·s *********/
    function updateHideElimUI(){
      if (!dom.toggleElimBtn) return;
      dom.toggleElimBtn.textContent = appState.hideElim ? "Show eliminated" : "Hide eliminated";
    }

    function initHideElim(){
      // Si l'URL ne précise rien, on reprend la dernière préférence (localStorage)
      if (!hideElimFromURL) {
        try{
          const saved = readStorage("kcaHideElim");
          appState.hideElim = (saved === "1");
        }catch(e){}
      }
      updateHideElimUI();
    }

    function isEliminatedAtPrime(eleve, primeNum){
      return (eleve.eliminatedAt != null && primeNum >= eleve.eliminatedAt);
    }

    function filterEliminated(list, primeNum){
      if (!appState.hideElim) return list;
      return list.filter(e => !isEliminatedAtPrime(e, primeNum));
    }

    function initPromosSelect() {
      const promos = ["all", ...uniq(eleves.map(e => e.promo))];
      dom.promoSelect.innerHTML = promos
        .map(p => `<option value="${p}">${p === "all" ? "Toutes promos" : p}</option>`)
        .join("");
      dom.promoSelect.value = appState.promo;
    }

    function setActiveTab(view) {
      dom.tabs.forEach(btn => {
        const isActive = btn.dataset.view === view;
        btn.classList.toggle("active", isActive);
        btn.setAttribute("aria-selected", isActive ? "true" : "false");
      });
    }

    function initInputsFromState() {
      dom.inputSearch.value = appState.q;
      dom.primeSelect.value = appState.prime;
      setActiveTab(appState.view);
    }

    function initElimSelect() {
      if (!dom.elimPrime) return;
      let html = '<option value="">Stage…</option>';
      for (let i = 0; i <= MAX_PRIME; i++) {
        html += `<option value="${i}">${STAGE_LABELS[i]}</option>`;
      }
      dom.elimPrime.innerHTML = html;
    }

    function updateModeUI() {
      if (!dom.modeToggle) return;
      dom.modeToggle.textContent = appState.isEditMode ? "View mode" : "Edit mode";

      // Met à jour l'éditeur d'élimination pour le/la candidat·e sélectionné·e
      const currentEleve = eleves.find(e => e.id === selectedId);
      updateElimEditor(currentEleve || null);
    }

    function initEditMode() {
      // Viewer mode: always read-only
      if (typeof VIEW_ONLY !== "undefined" && VIEW_ONLY) {
        appState.isEditMode = false;
        if (dom.modeToggle) dom.modeToggle.style.display = "none";
        updateModeUI();
        return;
      }

      try {
        const saved = readStorage("kcaEditMode");
        appState.isEditMode = (saved === "1");
      } catch (e) {
        appState.isEditMode = false;
      }
      updateModeUI();
    }

    function getFilteredBaseList() {
      let list = [...eleves];
      if (appState.promo !== "all") {
        list = list.filter(e => String(e.promo) === String(appState.promo));
      }
      if (appState.q) {
        const q = appState.q.toLowerCase();
        list = list.filter(e => e.nom.toLowerCase().includes(q));
      }
      return list;
    }

    function getPromoCount() {
      if (appState.promo === "all") return eleves.length;
      return eleves.filter(e => String(e.promo) === String(appState.promo)).length;
    }

    function renderTable(rows, primeNum) {
      dom.tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.dataset.id = r.id;
        if (r.eliminated) tr.classList.add("row-elim");

        const elimBadge = r.eliminated
          ? '<span class="chip elim">Eliminated</span>'
          : "";

        const deltaClass  = r.deltaPlaces>0 ? "up" : r.deltaPlaces<0 ? "down" : "";
        const deltaSymbol = r.deltaPlaces>0 ? "▲" : r.deltaPlaces<0 ? "▼" : "•";
        const deltaText   = Math.abs(r.deltaPlaces);

        const tdRank = document.createElement("td");
        tdRank.className = "rank sticky-rank";
        tdRank.textContent = r.rank;
        tr.appendChild(tdRank);

        const tdName = document.createElement("td");
        tdName.className = "name sticky-col";
        tdName.innerHTML = `
          <img alt="${r.nom}" class="avatar" src="${r.img}" onerror="this.src='assets/placeholder.jpg'"/>
          <span class="name-wrap">
            <span class="name-text">${r.nom}</span>
            ${elimBadge}
          </span>
          <span class="delta ${deltaClass}">
            ${deltaSymbol} ${deltaText}
          </span>
        `;
        tr.appendChild(tdName);

        // Colonnes PRERANK -> FINAL
        PRIMES_KEYS.forEach((key, idx) => {
          const td = document.createElement("td");
          td.className = "num";

          if (appState.isEditMode && !(typeof VIEW_ONLY !== "undefined" && VIEW_ONLY)) {
            const input = document.createElement("input");
            input.type = "number";
            input.className = "table-input";
            input.placeholder = "—";
            if (isScoreView(appState.view)) {
              input.min = "0";
              input.max = "100";
              input.step = "1";
            } else {
              input.min = "1";
              input.max = String(getPromoCount());
              input.step = "1";
            }
            input.dataset.id = r.id;
            input.dataset.source = appState.view;
            input.dataset.prime = String(idx);
            const val = eleves.find(e => e.id === r.id)[appState.view][key];
            input.value = val == null ? "" : String(val);
            input.addEventListener("input", onTableInputInput);
            input.addEventListener("change", onTableInputCommit);
            input.addEventListener("blur", onTableInputCommit);
            input.addEventListener("keydown", (ev) => {
              if (ev.key === "Enter") {
                ev.preventDefault();
                ev.target.blur();
              }
            });
            td.appendChild(input);
          } else {
            td.textContent = fmt(r[key]);
          }
          tr.appendChild(td);
        });

        const tdMoy = document.createElement("td");
        tdMoy.className = "num";
        const strong = document.createElement("strong");
        strong.textContent = fmt(r.moy);
        tdMoy.appendChild(strong);
        tr.appendChild(tdMoy);

        dom.tbody.appendChild(tr);
      });

      // Mise en évidence de la colonne du stage actif
      document.querySelectorAll("#top thead th").forEach(th => {
        th.style.color = "var(--muted)";
      });
      const thPrime = document.querySelector(`#top thead th[data-prime="${primeNum}"]`);
      if (thPrime) {
        thPrime.style.color = "var(--gold)";
      }
    }

    function updateProfile(eleve, row) {
      if (!eleve) {
        dom.pic.src = "assets/placeholder.jpg";
        dom.infoName.textContent  = "No contestant selected";
        dom.infoPromo.textContent = "";
        dom.infoExtra.textContent = "";
        updateElimEditor(null);
        return;
      }
      dom.pic.src = eleve.img || "assets/placeholder.jpg";
      dom.pic.onerror = () => { dom.pic.src = "assets/placeholder.jpg"; };

      dom.infoName.textContent  = eleve.nom;
      dom.infoPromo.textContent = "Season " + eleve.promo;

      const status = eleve.eliminatedAt != null
        ? `Eliminated à ${STAGE_LABELS[eleve.eliminatedAt] ?? ("Stage " + eleve.eliminatedAt)}`
        : "Still in the competition";

      const moyTxt  = row ? fmt(row.moy)  : "—";
      const rankTxt = row ? row.rank      : "—";

      dom.infoExtra.innerHTML = `
        Current rank : <strong>${rankTxt}</strong> •
        Average : <strong>${moyTxt}</strong> •
        ${status}
      `;
      updateElimEditor(eleve);
    }

    function updateElimEditor(eleve) {
      if (!dom.elimEditor) return;
      if (!appState.isEditMode || !eleve) {
        dom.elimEditor.style.display = "none";
        return;
      }
      dom.elimEditor.style.display = "block";
      dom.elimCheckbox.checked = eleve.eliminatedAt != null;
      dom.elimPrime.value = eleve.eliminatedAt != null ? String(eleve.eliminatedAt) : "";
    }

    function buildGlobalChart(baseList, view) {
      const labels = getLabelList();
      const sorted = [...baseList].sort((a,b)=>a.nom.localeCompare(b.nom));

      const datasets = sorted.map((e,idx) => {
        const src = sourceForView(e, view);
        const data = PRIMES_KEYS.map(key => src[key] == null ? null : Number(src[key]));
        const hue = (idx*37)%360;
        const strong = `hsl(${hue} 80% 60%)`;
        const faint  = `hsla(${hue},80%,60%,0.18)`;
        return {
          label:e.nom,
          data,
          tension:0.3,
          spanGaps:true,
          pointRadius:2,
          pointHitRadius:6,
          borderWidth:1,
          borderColor:faint,
          backgroundColor:faint,
          _id:e.id,
          _strongColor:strong,
          _faintColor:faint
        };
      });

      if (chartLine) chartLine.destroy();

      chartLine = new Chart(dom.chartCanvas.getContext("2d"), {
        type:"line",
        data:{ labels, datasets },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            y:{
              reverse: !isScoreView(view),
              suggestedMin: isScoreView(view) ? 0 : 1,
              suggestedMax: isScoreView(view) ? 100 : undefined,
              ticks:{ precision:0, callback:(v)=>v },
              title:{ display:true, text: isScoreView(view) ? "Score (100 = best)" : "Rank (1 = best)" }
            }
          },
          plugins:{
            legend:{ display:false },
            tooltip:{
              callbacks:{
                label:(ctx)=> isScoreView(view)
                  ? `${ctx.dataset.label} : score ${ctx.parsed.y}`
                  : `${ctx.dataset.label} : rang ${ctx.parsed.y}`
              }
            }
          }
        }
      });

      if (selectedId != null) highlightDataset(selectedId);
    }

    function highlightDataset(id) {
      if (!chartLine) return;
      selectedId = id;
      chartLine.data.datasets.forEach(ds => {
        if (id == null) {
          ds.borderColor   = ds._faintColor;
          ds.backgroundColor = ds._faintColor;
          ds.borderWidth   = 1;
          ds.pointRadius   = 2;
        } else if (ds._id === id) {
          ds.borderColor   = ds._strongColor;
          ds.backgroundColor = ds._strongColor;
          ds.borderWidth   = 3;
          ds.pointRadius   = 5;
        } else {
          ds.borderColor   = ds._faintColor;
          ds.backgroundColor = ds._faintColor;
          ds.borderWidth   = 1;
          ds.pointRadius   = 2;
        }
      });
      chartLine.update("none");
    }

    function selectRowById(id, rows) {
      dom.tbody.querySelectorAll("tr").forEach(tr => {
        tr.classList.toggle("selected", Number(tr.dataset.id) === id);
      });
      const eleve = eleves.find(e => e.id === id);
      const row   = rows.find(r => r.id === id);
      updateProfile(eleve, row);
      highlightDataset(id);
    }

    /*********************************
     * Cycle principal
     *********************************/
    function apply() {
      const baseListAll = getFilteredBaseList();
      const primeNum = primeToNum(appState.prime);

      const baseList = filterEliminated(baseListAll, primeNum);

      let rows = compute(baseList, primeNum, appState.view);

      if (appState.nameAsc) {
        rows = rows
          .slice()
          .sort((a,b)=>a.nom.localeCompare(b.nom))
          .map((x,i)=>({ ...x, rank:i+1 }));
      }

      renderTable(rows, primeNum);
      buildGlobalChart(baseList, appState.view);
      try {
        writeParamsToURL({
          ...appState,
          sort: appState.nameAsc ? "name" : "rank"
        });
      } catch (e) {
        console.warn("Unable to update the URL:", e);
      }

      if (rows.length) {
        // garder la sélection si possible
        let idToSelect = selectedId;
        if (idToSelect == null || !rows.some(r => r.id === idToSelect)) {
          idToSelect = rows[0].id;
        }
        selectRowById(idToSelect, rows);
      } else {
        selectedId = null;
        highlightDataset(null);
        updateProfile(null,null);
      }
    }

    /*********************************
     * Événements
     *********************************/
    function parseAndStoreInput(input) {
      const id = Number(input.dataset.id);
      const source = input.dataset.source;
      const primeIndex = Number(input.dataset.prime);
      const eleve = eleves.find(el => el.id === id);
      if (!eleve || !source) return;
      const key = "p" + primeIndex;
      const valStr = String(input.value ?? "").trim();
      eleve[source][key] = valStr === "" ? null : Number(valStr);
    }

    let saveTimer = null;
    function scheduleSave() {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        saveData();
        saveTimer = null;
      }, 120);
    }

    function onTableInputInput(e) {
      const input = e.target;
      parseAndStoreInput(input);
      // On sauvegarde sans rerender pour éviter les re-tris pendant la saisie
      scheduleSave();
    }

    function onTableInputCommit(e) {
      const input = e.target;
      parseAndStoreInput(input);
      saveData();
      apply();
    }


    function bindEvents() {
      dom.inputSearch.addEventListener("input", e => {
        appState.q = e.target.value;
        apply();
      });
      dom.promoSelect.addEventListener("change", e => {
        appState.promo = e.target.value;
        apply();
      });
      dom.primeSelect.addEventListener("change", e => {
        appState.prime = e.target.value;
        apply();
      });
      dom.sortBtn.addEventListener("click", () => {
        appState.nameAsc = !appState.nameAsc;
        apply();
      });

      if (dom.toggleElimBtn) {
        dom.toggleElimBtn.addEventListener("click", () => {
          appState.hideElim = !appState.hideElim;
          updateHideElimUI();
          try{
            writeStorage("kcaHideElim", appState.hideElim ? "1" : "0");
          }catch(e){}
          apply();
        });
      }

      dom.shareBtn.addEventListener("click", async () => {
        const u = new URL(location.href);
        if (!(typeof VIEW_ONLY !== "undefined" && VIEW_ONLY)) u.searchParams.set("viewer","1");
        const url = u.toString();
        try {
          await navigator.clipboard.writeText(url);
          alert("Link copied!");
        } catch {
          prompt("Copie le lien :", url);
        }
      });
      dom.tabs.forEach(btn => {
        btn.addEventListener("click", () => {
          appState.view = btn.dataset.view;
          setActiveTab(appState.view);
          apply();
        });
      });
      dom.tbody.addEventListener("click", e => {
        if (e.target && e.target.closest && e.target.closest("input")) return;
        const tr = e.target.closest("tr");
        if (!tr) return;
        const id = Number(tr.dataset.id);

        const baseListAll = getFilteredBaseList();
        const primeNum = primeToNum(appState.prime);
        const baseList = filterEliminated(baseListAll, primeNum);
        let rows = compute(baseList, primeNum, appState.view);
        if (appState.nameAsc) {
          rows = rows
            .slice()
            .sort((a,b)=>a.nom.localeCompare(b.nom))
            .map((x,i)=>({ ...x, rank:i+1 }));
        }
        selectRowById(id, rows);
      });

      if (dom.themeToggle){
        dom.themeToggle.addEventListener("click", () => {
          const current = document.body.dataset.theme || "dark";
          const next = current === "dark" ? "light" : "dark";
          applyTheme(next);
        });
      }

      if (dom.modeToggle) {
        if (typeof VIEW_ONLY !== "undefined" && VIEW_ONLY) {
          // Hide edit toggle for candidates
          dom.modeToggle.style.display = "none";
        } else {
          dom.modeToggle.addEventListener("click", () => {
            appState.isEditMode = !appState.isEditMode;
            updateModeUI();
            try {
              writeStorage("kcaEditMode", appState.isEditMode ? "1" : "0");
            } catch (e) {}
            apply();
          });
        }
      }

      if (dom.elimCheckbox && dom.elimPrime) {
        if (typeof VIEW_ONLY !== "undefined" && VIEW_ONLY) {
          dom.elimCheckbox.disabled = true;
          dom.elimPrime.disabled = true;
        }

        const onElimChange = () => {
          if (selectedId == null) return;
          const eleve = eleves.find(e => e.id === selectedId);
          if (!eleve) return;

          if (!dom.elimCheckbox.checked) {
            // ➜ On enlève l’élimination
            eleve.eliminatedAt = null;
            dom.elimPrime.value = "";
          } else {
            // ➜ Si aucun stage n’est choisi, on prend le stage actif
            let v = dom.elimPrime.value;
            if (v === "") {
              const primeNum = primeToNum(appState.prime);
              eleve.eliminatedAt = primeNum;
              dom.elimPrime.value = String(primeNum);
            } else {
              eleve.eliminatedAt = Number(v);
            }
          }

          saveData();
          apply();
        };
        dom.elimCheckbox.addEventListener("change", onElimChange);
        dom.elimPrime.addEventListener("change", onElimChange);
      }
    }

    function init() {
      loadSavedData();
      initTheme();
      initPromosSelect();
      initInputsFromState();
      initHideElim();
      initElimSelect();
      initEditMode();
      bindEvents();
      apply();
    }

    init();
  })();
  </script>
</body>
</html>
